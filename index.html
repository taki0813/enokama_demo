<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æ±Ÿãƒå³¶ãƒ»éŒå€‰ AIè¦³å…‰ãƒ«ãƒ¼ãƒˆç”Ÿæˆ - ãƒ‡ãƒ¢</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- GSAP (optional for subtle motion) -->
  <script src="https://unpkg.com/gsap@3/dist/gsap.min.js"></script>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Noto+Sans+JP:wght@400;500;700&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root{
      /* deeper Shonan palette */
      --sea-top: #aef4ff;       /* sky-ish */
      --sea-mid: #00bcd4;       /* vivid aqua */
      --sea-deep: #007c91;      /* deeper ocean */
      --sand: #fff6ec;
      --glass-border: rgba(255,255,255,0.46);
      --text-deep: #023643;     /* dark navy for contrast */
    }
    html,body{height:100%;margin:0;font-family:"Poppins","Noto Sans JP","Noto Sans KR",system-ui,-apple-system,"Segoe UI",Roboto,Arial;background: linear-gradient(180deg,var(--sea-top) 0%, #e6fbff 20%, #fffaf0 100%);color:var(--text-deep);}
    /* Ocean waves - stronger colors */
    .ocean-wrap{position:fixed;left:0;right:0;bottom:0;height:34vh;pointer-events:none;z-index:0;overflow:hidden;}
    .ocean-svg{position:absolute;left:-12%;width:124%;bottom:-8vh;opacity:0.9;filter: blur(6px) saturate(1.05);transform-origin:center;animation: drift 24s linear infinite;}
    .ocean-svg.layer2{bottom:-10vh;opacity:0.75;animation-duration:34s;filter: blur(8px);}
    .ocean-svg.layer3{bottom:-14vh;opacity:0.42;animation-duration:46s;filter: blur(12px);}
    @keyframes drift{0%{transform:translateX(0) translateY(0);}50%{transform:translateX(-6%) translateY(3%);}100%{transform:translateX(0) translateY(0);}}

    /* glass surfaces */
    .glass{ background: linear-gradient(180deg, rgba(255,255,255,0.7), rgba(255,255,255,0.46)); border:1px solid var(--glass-border); backdrop-filter: blur(10px) saturate(110%); box-shadow: 0 10px 40px rgba(2,6,23,0.06); border-radius:16px;}
    .glass-strong{ background: linear-gradient(180deg, rgba(255,255,255,0.85), rgba(255,255,255,0.6)); border:1px solid rgba(255,255,255,0.7); backdrop-filter: blur(16px) saturate(120%); box-shadow:0 12px 44px rgba(2,6,23,0.06); border-radius:18px;}

    /* buttons - improved contrast (no white-on-white) */
    .glass-btn {
      background: linear-gradient(90deg, rgba(0,188,212,0.12), rgba(255,255,255,0.9));
      color: var(--text-deep);
      border: 1px solid rgba(0,124,145,0.16);
      padding: 0.9rem 1.2rem;
      border-radius: 14px;
      font-weight: 700;
      box-shadow: 0 10px 30px rgba(0,124,145,0.06);
      transition: transform .18s ease, box-shadow .18s ease;
    }
    .glass-btn:disabled { opacity: 0.45; transform:none; pointer-events:none; }
    .glass-btn:hover { transform: translateY(-3px); box-shadow: 0 18px 40px rgba(0,124,145,0.12); }

    /* language select */
    .lang-select { appearance:none; -webkit-appearance:none; background: linear-gradient(90deg, rgba(0,188,212,0.12), rgba(61,215,240,0.06)); border:1px solid rgba(0,124,145,0.28); color:var(--text-deep); padding:8px 10px; border-radius:12px; font-weight:700; font-size:0.95rem; backdrop-filter: blur(8px);}
    .lang-wrap{ position:relative; display:inline-block; }
    .lang-wrap::after{ content:"â–¾"; position:absolute; right:10px; top:50%; transform:translateY(-50%); pointer-events:none; color: rgba(4,53,69,0.6); font-size:0.75rem; }

    /* progress bar */
    #progress-bar { height:0.6rem; border-radius:999px; background: linear-gradient(90deg, var(--sea-mid), var(--sea-deep)); width:0%; transition: width .28s ease; }

    /* options */
    .option-label { transition: all .16s ease; border-radius:12px; border:1px solid rgba(4,37,52,0.06); }
    .option-label:hover{ transform: translateY(-2px); box-shadow: 0 10px 24px rgba(0,124,145,0.06); }
    .option-label.active { border-color: rgba(0,124,145,0.48); background: linear-gradient(90deg, rgba(0,188,212,0.04), rgba(61,215,240,0.02)); box-shadow: 0 12px 28px rgba(0,124,145,0.06); }

    /* timeline / plan */
    .timeline { position:relative; padding-left:2.25rem; }
    .timeline::before { content:""; position:absolute; left:0.95rem; top:0.5rem; bottom:0; width:4px; background: linear-gradient(180deg, rgba(0,188,212,0.18), rgba(0,124,145,0.06)); border-radius:3px; }
    .timeline-item { position:relative; margin-bottom:1rem; }
    .timeline-dot { position:absolute; left:-0.38rem; top:0.6rem; width:14px; height:14px; border-radius:999px; background: linear-gradient(180deg, var(--sea-mid), var(--sea-deep)); box-shadow:0 6px 16px rgba(0,124,145,0.14); border:3px solid white; }

    .spot-card { background: rgba(255,255,255,0.86); border-radius:14px; padding:1rem; box-shadow:0 12px 28px rgba(2,6,23,0.06); }
    .spot-title { font-weight:800; color:var(--text-deep); }
    .spot-desc { color:#475569; font-size:0.95rem; margin-top:0.25rem; }
    .spot-tips { margin-top:0.6rem; font-size:0.85rem; color:#334155; background: linear-gradient(90deg, rgba(255,255,255,0.8), rgba(255,255,255,0.6)); padding:0.6rem; border-radius:10px; border:1px solid rgba(14,165,191,0.06); }

    .move-card { background: linear-gradient(90deg, rgba(0,188,212,0.10), rgba(0,188,212,0.04)); border-radius:12px; padding:0.8rem; display:flex; gap:0.75rem; align-items:center; border-left:4px solid rgba(0,124,145,0.36); color:var(--text-deep); }
    .move-icon { width:44px; height:44px; min-width:44px; border-radius:10px; display:flex; align-items:center; justify-content:center; background: linear-gradient(180deg, var(--sea-mid), var(--sea-deep)); color:white; box-shadow:0 8px 20px rgba(0,124,145,0.12); }

    .time-badge { font-size:0.85rem; color:#07505b; font-weight:700; }

    .checkin-btn { margin-top:0.6rem; padding:8px 12px; border-radius:10px; background: linear-gradient(90deg, rgba(255,255,255,0.96), rgba(0,188,212,0.06)); color:var(--text-deep); border:1px solid rgba(0,124,145,0.12); font-weight:700; }
    .checked-badge { display:inline-block; margin-left:8px; padding:4px 8px; background:linear-gradient(90deg,var(--sea-deep),var(--sea-mid)); color:white; border-radius:999px; font-size:0.78rem; font-weight:700; }

    .fade-in { animation: fadeInUp .52s ease both; }
    @keyframes fadeInUp { from{ opacity:0; transform: translateY(8px);} to{opacity:1; transform:none;} }

    #map{ height:420px; border-radius:14px; box-shadow: 0 10px 28px rgba(2,6,23,0.06); }
    #nav-bar{ background: linear-gradient(180deg, rgba(255,255,255,0.86), rgba(255,255,255,0.72)); backdrop-filter: blur(8px); border-top:1px solid rgba(255,255,255,0.6); }
    .pb-safe { padding-bottom: calc(env(safe-area-inset-bottom) + 1rem); }
    @media (max-width:420px){ #map{ height:300px; } }
  </style>
</head>
<body class="min-h-screen">

  <!-- Ocean wave layers (deeper tones) -->
  <div class="ocean-wrap" aria-hidden="true">
    <svg class="ocean-svg" viewBox="0 0 1440 320" preserveAspectRatio="none">
      <path fill="#00bcd4" d="M0,224L48,202.7C96,181,192,139,288,117.3C384,96,480,96,576,122.7C672,149,768,203,864,218.7C960,235,1056,213,1152,213.3C1248,213,1344,235,1392,245.3L1440,256L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path>
    </svg>
    <svg class="ocean-svg layer2" viewBox="0 0 1440 320" preserveAspectRatio="none">
      <path fill="#007c91" d="M0,160L40,165.3C80,171,160,181,240,181.3C320,181,400,171,480,154.7C560,139,640,117,720,122.7C800,128,880,160,960,176C1040,192,1120,192,1200,208C1280,224,1360,256,1400,272L1440,288L1440,320L1400,320C1360,320,1280,320,1200,320C1120,320,1040,320,960,320C880,320,800,320,720,320C640,320,560,320,480,320C400,320,320,320,240,320C160,320,80,320,40,320L0,320Z"></path>
    </svg>
    <svg class="ocean-svg layer3" viewBox="0 0 1440 320" preserveAspectRatio="none">
      <path fill="#e8fbff" d="M0,96L60,101.3C120,107,240,117,360,144C480,171,600,213,720,213.3C840,213,960,171,1080,149.3C1200,128,1320,128,1380,128L1440,128L1440,320L1380,320C1320,320,1200,320,1080,320C960,320,840,320,720,320C600,320,480,320,360,320C240,320,120,320,60,320L0,320Z"></path>
    </svg>
  </div>

  <div id="app" class="max-w-md mx-auto relative z-10 pb-safe">

    <!-- Language control (right-top) -->
    <div class="fixed top-3 right-3 z-50">
      <div class="lang-wrap">
        <select id="lang-select" class="lang-select" aria-label="è¨€èªé¸æŠ">
          <option value="ja">æ—¥æœ¬èª</option>
          <option value="en">English</option>
          <option value="zh">ä¸­æ–‡</option>
          <option value="ko">í•œêµ­ì–´</option>
        </select>
      </div>
    </div>

    <!-- Intro screen -->
    <div id="intro-screen" class="p-4 space-y-8 pt-12 fade-in">
      <div class="text-center space-y-6">
        <div class="relative inline-block">
          <div class="w-24 h-24 bg-gradient-to-br from-[color:var(--sea-mid)] to-[color:var(--sea-deep)] rounded-3xl flex items-center justify-center mx-auto shadow-lg glass-strong">
            <svg class="h-12 w-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
          </div>
          <div class="absolute -top-2 -right-2 w-8 h-8 bg-yellow-400 rounded-full flex items-center justify-center shadow">
            <svg class="h-4 w-4 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
          </div>
        </div>

        <div class="space-y-3">
          <h1 data-i18n="app.title" class="text-4xl font-bold bg-clip-text text-transparent" style="background-image: linear-gradient(90deg, var(--sea-mid), var(--sea-deep));">æ±Ÿãƒå³¶ãƒ»éŒå€‰</h1>
          <h2 data-i18n="app.subtitle" class="text-xl font-semibold text-gray-700">AIè¦³å…‰ãƒ«ãƒ¼ãƒˆç”Ÿæˆ</h2>
          <p data-i18n="app.partners" class="text-sm text-gray-500 glass inline-block px-4 py-2 rounded-full">ä¸­å¤®å¤§å­¦å²¡å¶‹ã‚¼ãƒŸ Ã— ç¥å¥ˆå·çœŒè¦³å…‰å”ä¼š</p>
        </div>
      </div>

      <div class="glass-strong overflow-hidden">
        <div class="bg-gradient-to-r from-[color:var(--sea-mid)] to-[color:var(--sea-deep)] text-white p-6">
          <h3 class="flex items-center gap-3 text-xl font-bold">
            <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
            <span data-i18n="intro.about">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã¤ã„ã¦</span>
          </h3>
        </div>

        <div class="p-6 space-y-6">
          <p data-i18n="intro.lead" class="text-gray-600 text-center">ã‚ãªãŸã®å¥½ã¿ã«åˆã‚ã›ã¦æœ€é©ãªè¦³å…‰ãƒ«ãƒ¼ãƒˆã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã™ã€‚</p>
          <div class="grid gap-4">
            <div class="flex items-start gap-4 p-4 bg-gradient-to-r from-blue-50 to-blue-100 rounded-2xl">
              <div class="w-12 h-12 bg-[color:var(--sea-mid)] rounded-2xl flex items-center justify-center glass">
                <svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/></svg>
              </div>
              <div>
                <h4 data-i18n="intro.feature1.title" class="font-semibold text-gray-800 text-base">AIãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚º</h4>
                <p data-i18n="intro.feature1.desc" class="text-sm text-gray-600 mt-1">è¨ºæ–­çµæœã«åŸºã¥ã„ã¦ã€ã‚ãªãŸã ã‘ã®è¦³å…‰ãƒ—ãƒ©ãƒ³ã‚’ç”Ÿæˆ</p>
              </div>
            </div>

            <div class="flex items-start gap-4 p-4 bg-gradient-to-r from-green-50 to-green-100 rounded-2xl">
              <div class="w-12 h-12 bg-[color:var(--sea-deep)] rounded-2xl flex items-center justify-center glass">
                <svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
              </div>
              <div>
                <h4 data-i18n="intro.feature2.title" class="font-semibold text-gray-800 text-base">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³</h4>
                <p data-i18n="intro.feature2.desc" class="text-sm text-gray-600 mt-1">GPSé€£å‹•ã§è¦³å…‰åœ°ã‚’è¨ªå•ã—ã¦ãƒã‚¤ãƒ³ãƒˆã‚’ç²å¾—</p>
              </div>
            </div>

            <div class="flex items-start gap-4 p-4 bg-gradient-to-r from-yellow-50 to-yellow-100 rounded-2xl">
              <div class="w-12 h-12 bg-yellow-400 rounded-2xl flex items-center justify-center glass">
                <svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/></svg>
              </div>
              <div>
                <h4 data-i18n="intro.feature3.title" class="font-semibold text-gray-800 text-base">ç‰¹å…¸ã‚¯ãƒ¼ãƒãƒ³</h4>
                <p data-i18n="intro.feature3.desc" class="text-sm text-gray-600 mt-1">è¦³å…‰åœ°ã§ã®å‰²å¼•ã‚„ç‰¹å…¸ã‚’å³åº§ã«ç²å¾—</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <button id="start-btn" data-i18n="intro.start" onclick="startDiagnosis()" class="w-full glass-btn text-[color:var(--text-deep)] font-semibold text-lg rounded-2xl shadow-lg transform transition-all duration-200 hover:scale-105">
        AIè¦³å…‰ãƒ«ãƒ¼ãƒˆç”Ÿæˆã‚’é–‹å§‹
      </button>
    </div>

    <!-- Diagnosis screen -->
    <div id="diagnosis-screen" class="hidden p-4 space-y-6 pt-8 fade-in">
      <div class="text-center space-y-4">
        <div class="relative inline-block">
          <div class="w-16 h-16 bg-gradient-to-br from-[color:var(--sea-mid)] to-[color:var(--sea-deep)] rounded-2xl flex items-center justify-center mx-auto shadow-lg glass">
            <svg class="h-8 w-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
          </div>
          <div class="absolute -top-1 -right-1 w-6 h-6 bg-yellow-400 rounded-full flex items-center justify-center shadow">
            <span id="step-number" class="text-xs font-bold text-white">1</span>
          </div>
        </div>

        <div>
          <h1 class="text-2xl font-bold bg-clip-text text-transparent" style="background-image: linear-gradient(90deg, var(--sea-mid), var(--sea-deep));">æ±Ÿãƒå³¶ãƒ»éŒå€‰è¦³å…‰ã‚¬ã‚¤ãƒ‰</h1>
          <p class="text-gray-600 mt-2">ã‚ãªãŸã«ã´ã£ãŸã‚Šã®è¦³å…‰ãƒ—ãƒ©ãƒ³ã‚’è¨ºæ–­ã—ã¾ã™</p>
        </div>
      </div>

      <div class="space-y-3">
        <div class="flex justify-between text-sm text-gray-600">
          <span class="font-medium" data-i18n="diagnosis.progress">è¨ºæ–­é€²è¡ŒçŠ¶æ³</span>
          <span class="bg-white/60 glass px-3 py-1 rounded-full"><span id="step-progress">1</span> / <span id="total-steps">10</span></span>
        </div>
        <div class="bg-white/60 backdrop-blur-sm rounded-full p-1">
          <div id="progress-bar" class=""></div>
        </div>
      </div>

      <div class="glass-strong overflow-hidden">
        <div class="bg-gradient-to-r from-[color:var(--sea-mid)] to-[color:var(--sea-deep)] text-white p-6">
          <h2 id="question-title" class="text-xl font-bold">æ€§åˆ¥ã‚’æ•™ãˆã¦ãã ã•ã„</h2>
        </div>
        <div id="question-content" class="p-6"></div>
      </div>

      <div class="flex gap-4">
        <button id="back-btn" data-i18n="common.back" onclick="previousStep()" class="hidden flex-1 h-12 rounded-2xl border-2 border-gray-300 text-gray-600 hover:bg-gray-50 hover:border-gray-400 transition-all duration-200">æˆ»ã‚‹</button>
        <button id="next-btn" onclick="nextStep()" class="flex-1 h-12 glass-btn text-[color:var(--text-deep)] rounded-2xl shadow-lg transform transition-all duration-200 hover:scale-105 disabled:opacity-50">
          æ¬¡ã¸
        </button>
      </div>
    </div>

    <!-- Loading -->
    <div id="loading-screen" class="hidden p-4 pt-20">
      <div class="text-center space-y-8">
        <div class="relative inline-block">
          <div class="w-24 h-24 bg-gradient-to-br from-[color:var(--sea-mid)] to-[color:var(--sea-deep)] rounded-3xl flex items-center justify-center mx-auto shadow-lg glass-strong">
            <div class="w-12 h-12 border-4 border-white border-t-transparent rounded-full animate-spin"></div>
          </div>
        </div>
        <div class="space-y-3">
          <h2 class="text-2xl font-bold bg-clip-text text-transparent" style="background-image: linear-gradient(90deg, var(--sea-mid), var(--sea-deep));">AIãŒè¦³å…‰ãƒ—ãƒ©ãƒ³ã‚’ç”Ÿæˆä¸­...</h2>
          <p class="text-gray-600">ã‚ãªãŸã®å¥½ã¿ã‚’åˆ†æã—ã¦æœ€é©ãªãƒ«ãƒ¼ãƒˆã‚’ææ¡ˆã—ã¦ã„ã¾ã™</p>
        </div>
      </div>
    </div>

    <!-- Results -->
    <div id="results-screen" class="hidden p-4 space-y-6 pt-8">
      <div class="text-center space-y-4">
        <div class="relative inline-block">
          <div class="w-20 h-20 bg-gradient-to-br from-[color:var(--sea-mid)] to-[color:var(--sea-deep)] rounded-3xl flex items-center justify-center mx-auto shadow-lg glass">
            <svg class="h-10 w-10 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
          </div>
        </div>
        <div>
          <h1 class="text-3xl font-bold bg-clip-text text-transparent" style="background-image: linear-gradient(90deg, var(--sea-mid), var(--sea-deep));">ã‚ãªãŸã«ãŠã™ã™ã‚ã®è¦³å…‰ãƒ—ãƒ©ãƒ³</h1>
          <p class="text-gray-600 mt-2">è¨ºæ–­çµæœã«åŸºã¥ã„ã¦æœ€é©ãªãƒ«ãƒ¼ãƒˆã‚’ã”ææ¡ˆã—ã¾ã™</p>
        </div>
      </div>

      <div class="glass-strong overflow-hidden">
        <div class="bg-gradient-to-r from-[color:var(--sea-mid)] to-[color:var(--sea-deep)] text-white p-6">
          <h2 class="flex items-center gap-3 text-xl font-bold"><span id="area-title">æ±Ÿãƒå³¶ãƒ»éŒå€‰</span> è¦³å…‰ã‚³ãƒ¼ã‚¹</h2>
          <div class="text-blue-100 mt-2" id="travel-style-text">ã‚†ã£ãŸã‚Šã¨æ¥½ã—ã‚€ã‚³ãƒ¼ã‚¹</div>
        </div>

        <div class="p-6 space-y-6">
          <div class="flex items-center gap-3 text-sm text-gray-600 bg-gray-50 p-3 rounded-2xl">
            <svg class="h-5 w-5 text-[color:var(--sea-mid)]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            <span class="font-semibold" id="est-time">æ‰€è¦æ™‚é–“: ç´„3æ™‚é–“45åˆ†</span>
          </div>

          <!-- Timeline container -->
          <div id="spots-list" class="timeline"></div>

          <!-- Lottery / progress -->
          <div class="mt-2 flex items-center justify-between gap-3">
            <div class="text-sm text-gray-600">ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³é”æˆç‡: <span id="checkin-rate">0%</span></div>
            <button id="lottery-btn" class="glass-btn" disabled onclick="enterLottery()">ğŸ æŠ½é¸ã«å‚åŠ ã™ã‚‹</button>
          </div>
        </div>
      </div>

      <div class="space-y-4">
        <button data-i18n="results.view_map" onclick="showScreen('map')" class="w-full h-14 glass-btn text-[color:var(--text-deep)] rounded-2xl shadow-lg transform transition-all duration-200 hover:scale-105">åœ°å›³ã§è©³ç´°ãƒ«ãƒ¼ãƒˆã‚’è¦‹ã‚‹</button>
        <button data-i18n="results.view_coupons" onclick="showScreen('coupons')" class="w-full h-14 border-2 border-[color:var(--sea-mid)] text-[color:var(--sea-deep)] hover:bg-[color:#f0fffe] rounded-2xl transition-all duration-200">ã‚¯ãƒ¼ãƒãƒ³ã‚’è¦‹ã‚‹</button>
      </div>
    </div>

    <!-- Map -->
    <div id="map-screen" class="hidden p-4 space-y-4 pt-8 fade-in">
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-bold text-gray-800" data-i18n="map.title">åœ°å›³ã§ãƒ«ãƒ¼ãƒˆã‚’ç¢ºèª</h2>
        <button onclick="showScreen('results')" class="text-[color:var(--sea-mid)] underline">ãƒ—ãƒ©ãƒ³ã«æˆ»ã‚‹</button>
      </div>
      <div id="map" class="bg-gray-200"></div>
      <div class="text-xs text-gray-500">åœ°å›³: Â© OpenStreetMap contributors</div>
      <div id="transit-info" class="space-y-3"></div>
    </div>

    <!-- Coupons -->
    <div id="coupons-screen" class="hidden p-4 space-y-4 pt-8 fade-in">
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-bold text-gray-800" data-i18n="coupon.title">ç²å¾—ã‚¯ãƒ¼ãƒãƒ³</h2>
        <button onclick="showScreen('results')" class="text-[color:var(--sea-mid)] underline">ãƒ—ãƒ©ãƒ³ã«æˆ»ã‚‹</button>
      </div>
      <div id="coupon-list" class="space-y-3"></div>
    </div>

    <!-- Coupon detail -->
    <div id="coupon-detail-screen" class="hidden p-4 space-y-4 pt-8 fade-in">
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-bold text-gray-800">ã‚¯ãƒ¼ãƒãƒ³è©³ç´°</h2>
        <button onclick="showScreen('coupons')" class="text-[color:var(--sea-mid)] underline">ä¸€è¦§ã«æˆ»ã‚‹</button>
      </div>
      <div class="bg-white rounded-2xl border p-5 space-y-3 glass">
        <div class="text-lg font-semibold text-gray-800" id="cd-title"></div>
        <div class="text-sm text-gray-500" id="cd-spot"></div>
        <div class="text-sm text-gray-700" id="cd-desc"></div>
        <div class="flex items-center justify-between">
          <div class="text-base font-bold text-[color:var(--sea-mid)]" id="cd-discount"></div>
          <div class="text-xs text-gray-500" id="cd-valid"></div>
        </div>
        <div id="cd-status" class="text-sm"></div>
        <button id="cd-use" class="w-full h-11 rounded-xl text-white bg-[color:var(--sea-mid)] hover:bg-[color:#06b6d4] transition">ä½¿ã†</button>
      </div>
    </div>

  </div>

  <!-- Nav bar -->
  <div id="nav-bar" class="hidden fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-md border-t border-gray-200 p-4 z-50">
    <div class="max-w-md mx-auto flex justify-around">
      <button onclick="showScreen('intro')" class="flex flex-col items-center gap-1 p-2 rounded-xl transition-all duration-200 text-gray-500">
        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
        <span class="text-xs font-medium" data-i18n="nav.home">ãƒ›ãƒ¼ãƒ </span>
      </button>
      <button onclick="showScreen('diagnosis')" class="flex flex-col items-center gap-1 p-2 rounded-xl transition-all duration-200 text-gray-500">
        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
        <span class="text-xs font-medium" data-i18n="nav.diagnosis">è¨ºæ–­</span>
      </button>
      <button onclick="showScreen('results')" class="flex flex-col items-center gap-1 p-2 rounded-xl transition-all duration-200 text-gray-500">
        <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
        <span class="text-xs font-medium" data-i18n="nav.plan">ãƒ—ãƒ©ãƒ³</span>
      </button>
      <button onclick="showScreen('map')" class="flex flex-col items-center gap-1 p-2 rounded-xl transition-all duration-200 text-gray-500">
        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
        <span class="text-xs font-medium" data-i18n="nav.map">åœ°å›³</span>
      </button>
      <button onclick="showScreen('coupons')" class="flex flex-col items-center gap-1 p-2 rounded-xl transition-all duration-200 text-gray-500">
        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/></svg>
        <span class="text-xs font-medium" data-i18n="nav.coupons">ã‚¯ãƒ¼ãƒãƒ³</span>
      </button>
    </div>
  </div>

  <script>
    /* ==========================
       i18n texts (ja/en/zh/ko)
       Keys used across UI and STEPS
       ========================== */
    let currentLang = 'ja';

    const TEXTS = {
      ja: {
        'app.title':'æ±Ÿãƒå³¶ãƒ»éŒå€‰','app.subtitle':'AIè¦³å…‰ãƒ«ãƒ¼ãƒˆç”Ÿæˆ','app.partners':'ä¸­å¤®å¤§å­¦å²¡å¶‹ã‚¼ãƒŸ Ã— ç¥å¥ˆå·çœŒè¦³å…‰å”ä¼š',
        'intro.about':'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã¤ã„ã¦','intro.lead':'ã‚ãªãŸã®å¥½ã¿ã«åˆã‚ã›ã¦æœ€é©ãªè¦³å…‰ãƒ«ãƒ¼ãƒˆã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã™ã€‚',
        'intro.feature1.title':'AIãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚º','intro.feature1.desc':'è¨ºæ–­çµæœã«åŸºã¥ã„ã¦ã€ã‚ãªãŸã ã‘ã®è¦³å…‰ãƒ—ãƒ©ãƒ³ã‚’ç”Ÿæˆ',
        'intro.feature2.title':'ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³','intro.feature2.desc':'GPSé€£å‹•ã§è¦³å…‰åœ°ã‚’è¨ªå•ã—ã¦ãƒã‚¤ãƒ³ãƒˆã‚’ç²å¾—',
        'intro.feature3.title':'ç‰¹å…¸ã‚¯ãƒ¼ãƒãƒ³','intro.feature3.desc':'è¦³å…‰åœ°ã§ã®å‰²å¼•ã‚„ç‰¹å…¸ã‚’å³åº§ã«ç²å¾—',
        'intro.start':'AIè¦³å…‰ãƒ«ãƒ¼ãƒˆç”Ÿæˆã‚’é–‹å§‹','diagnosis.progress':'è¨ºæ–­é€²è¡ŒçŠ¶æ³','common.back':'æˆ»ã‚‹','common.next':'æ¬¡ã¸','diagnosis.view_result':'è¨ºæ–­çµæœã‚’è¦‹ã‚‹',
        'results.view_map':'åœ°å›³ã§è©³ç´°ãƒ«ãƒ¼ãƒˆã‚’è¦‹ã‚‹','results.view_coupons':'ã‚¯ãƒ¼ãƒãƒ³ã‚’è¦‹ã‚‹','map.title':'åœ°å›³ã§ãƒ«ãƒ¼ãƒˆã‚’ç¢ºèª',
        'coupon.title':'ç²å¾—ã‚¯ãƒ¼ãƒãƒ³','coupon.detail':'ã‚¯ãƒ¼ãƒãƒ³è©³ç´°','coupon.back_list':'ä¸€è¦§ã«æˆ»ã‚‹','coupon.use':'ä½¿ã†','coupon.used':'ä½¿ç”¨æ¸ˆã¿','coupon.confirm':'æœ¬å½“ã«ã“ã®ã‚¯ãƒ¼ãƒãƒ³ã‚’ä½¿ã„ã¾ã™ã‹ï¼Ÿä¸€åº¦ä½¿ç”¨æ¸ˆã¿ã«ã™ã‚‹ã¨æˆ»ã›ã¾ã›ã‚“ã€‚',
        'nav.home':'ãƒ›ãƒ¼ãƒ ','nav.diagnosis':'è¨ºæ–­','nav.plan':'ãƒ—ãƒ©ãƒ³','nav.map':'åœ°å›³','nav.coupons':'ã‚¯ãƒ¼ãƒãƒ³',
        'steps.gender.title':'æ€§åˆ¥ã‚’æ•™ãˆã¦ãã ã•ã„','options.gender.male':'ç”·æ€§','options.gender.female':'å¥³æ€§','options.gender.other':'ãã®ä»–',
        'steps.age.title':'å¹´é½¢å±¤ã‚’æ•™ãˆã¦ãã ã•ã„','options.age.10s':'10ä»£','options.age.20s':'20ä»£','options.age.30s':'30ä»£','options.age.40s':'40ä»£','options.age.50s':'50ä»£ä»¥ä¸Š',
        'steps.mustVisit.title':'çµ¶å¯¾ã«è¡ŒããŸã„å ´æ‰€ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ','options.mustVisit.enoshima':'æ±Ÿãƒå³¶','options.mustVisit.kamakura':'éŒå€‰','options.mustVisit.both':'ä¸¡æ–¹','options.mustVisit.undecided':'ã¾ã æ±ºã‚ã¦ã„ãªã„',
        'steps.travelStyle.title':'æ—…è¡Œã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ•™ãˆã¦ãã ã•ã„','options.travelStyle.relaxed':'ã‚†ã£ãã‚Šè¦³å…‰','options.travelStyle.active':'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«å›ã‚‹','options.travelStyle.cultural':'æ–‡åŒ–ãƒ»æ­´å²é‡è¦–','options.travelStyle.gourmet':'ã‚°ãƒ«ãƒ¡é‡è¦–',
        'steps.startLocation.title':'è¦³å…‰é–‹å§‹å ´æ‰€ã‚’æ•™ãˆã¦ãã ã•ã„','options.startLocation.enoshima_station':'æ±Ÿãƒå³¶é§…','options.startLocation.kamakura_station':'éŒå€‰é§…','options.startLocation.fujisawa_station':'è—¤æ²¢é§…','options.startLocation.other':'ãã®ä»–ï¼ˆè‡ªç”±è¨˜è¿°ï¼‰',
        'steps.customStartLocation.title':'ãã®ä»–ã®å ´åˆã¯é–‹å§‹å ´æ‰€ã‚’æ•™ãˆã¦ãã ã•ã„','steps.startTime.title':'è¦³å…‰é–‹å§‹æ™‚é–“ã‚’æ•™ãˆã¦ãã ã•ã„','steps.endTime.title':'å¸°è·¯ã«ã¤ãæ™‚é–“ã‚’æ•™ãˆã¦ãã ã•ã„',
        'steps.whatToDo.title':'ã‚„ã‚ŠãŸã„ã“ã¨ã‚’è‡ªç”±ã«æ•™ãˆã¦ãã ã•ã„','steps.customSpot.title':'ç‰¹ã«è¡ŒããŸã„å ´æ‰€ãŒã‚ã‚Œã°æ•™ãˆã¦ãã ã•ã„',
        'placeholder.customStartLocation':'ä¾‹: æ–°å®¿é§…ã€æ¨ªæµœé§…ã€è‡ªå®…ä½æ‰€ãªã©','placeholder.whatToDo':'ä¾‹: å†™çœŸã‚’æ’®ã‚ŠãŸã„ã€ç¾å‘³ã—ã„ã‚‚ã®ã‚’é£Ÿã¹ãŸã„ ãªã©','placeholder.customSpot':'ä¾‹: éŒå€‰æ–‡å­¦é¤¨ ãªã©',
        'results.stay':'æ»åœ¨æ™‚é–“','results.fee':'å…¥å ´æ–™'
      },
      en: {
        'app.title':'Enoshima & Kamakura','app.subtitle':'AI Tour Route Generator','app.partners':'Chuo Univ. Okajima Seminar Ã— Kanagawa Tourism',
        'intro.about':'About the Project','intro.lead':'We generate the best tour route tailored to your preferences.',
        'intro.feature1.title':'AI Personalization','intro.feature1.desc':'Generate a tour plan just for you',
        'intro.feature2.title':'Real-time Check-in','intro.feature2.desc':'Earn points by visiting spots via GPS',
        'intro.feature3.title':'Special Coupons','intro.feature3.desc':'Get discounts and perks instantly',
        'intro.start':'Start AI Route Generation','diagnosis.progress':'Progress','common.back':'Back','common.next':'Next','diagnosis.view_result':'View Results',
        'results.view_map':'View detailed route on Map','results.view_coupons':'View Coupons','map.title':'Check Route on Map',
        'coupon.title':'Coupons','coupon.detail':'Coupon Details','coupon.back_list':'Back to List','coupon.use':'Use','coupon.used':'Used','coupon.confirm':'Use this coupon? This cannot be undone.',
        'nav.home':'Home','nav.diagnosis':'Diagnosis','nav.plan':'Plan','nav.map':'Map','nav.coupons':'Coupons',
        'steps.gender.title':'Please tell us your gender','options.gender.male':'Male','options.gender.female':'Female','options.gender.other':'Other',
        'steps.age.title':'Please select your age group','options.age.10s':'Teens','options.age.20s':'20s','options.age.30s':'30s','options.age.40s':'40s','options.age.50s':'50+',
        'steps.mustVisit.title':'Any must-visit area?','options.mustVisit.enoshima':'Enoshima','options.mustVisit.kamakura':'Kamakura','options.mustVisit.both':'Both','options.mustVisit.undecided':'Undecided',
        'steps.travelStyle.title':'Your travel style','options.travelStyle.relaxed':'Relaxed','options.travelStyle.active':'Active','options.travelStyle.cultural':'Culture/History','options.travelStyle.gourmet':'Gourmet',
        'steps.startLocation.title':'Where do you start?','options.startLocation.enoshima_station':'Enoshima Station','options.startLocation.kamakura_station':'Kamakura Station','options.startLocation.fujisawa_station':'Fujisawa Station','options.startLocation.other':'Other (free text)',
        'steps.customStartLocation.title':'If other, please specify your start location','steps.startTime.title':'Select your start time','steps.endTime.title':'Select your return time',
        'steps.whatToDo.title':'Tell us what you want to do (optional)','steps.customSpot.title':'Any specific spot you want to visit? (optional)',
        'placeholder.customStartLocation':'e.g., Shinjuku Station, Yokohama, home address','placeholder.whatToDo':'e.g., Take many photos, eat tasty food, learn history','placeholder.customSpot':'e.g., Kamakura Museum of Literature',
        'results.stay':'Stay','results.fee':'Entrance fee'
      },
      zh: {
        'app.title':'æ±Ÿä¹‹å²›ãƒ»é•°ä»“','app.subtitle':'AI è§‚å…‰è·¯çº¿ç”Ÿæˆ','app.partners':'ä¸­å¤®å¤§å­¦å†ˆå¶‹ç ”ç©¶å®¤ Ã— ç¥å¥ˆå·å¿è§‚å…‰åä¼š',
        'intro.about':'é¡¹ç›®ç®€ä»‹','intro.lead':'æ ¹æ®æ‚¨çš„å–œå¥½è‡ªåŠ¨ç”Ÿæˆæœ€ä½³è§‚å…‰è·¯çº¿ã€‚',
        'intro.feature1.title':'AI ä¸ªæ€§åŒ–','intro.feature1.desc':'åŸºäºé—®ç­”ä¸ºæ‚¨ç”Ÿæˆä¸“å±è¡Œç¨‹',
        'intro.feature2.title':'å®æ—¶æ‰“å¡','intro.feature2.desc':'é€šè¿‡ GPS åˆ°è®¿æ™¯ç‚¹è·å¾—ç§¯åˆ†',
        'intro.feature3.title':'ä¼˜æƒ åˆ¸','intro.feature3.desc':'å³æ—¶è·å–æŠ˜æ‰£ä¸ç‰¹å…¸',
        'intro.start':'å¼€å§‹ç”Ÿæˆ AI è·¯çº¿','diagnosis.progress':'è¿›åº¦','common.back':'è¿”å›','common.next':'ä¸‹ä¸€æ­¥','diagnosis.view_result':'æŸ¥çœ‹ç»“æœ',
        'results.view_map':'åœ¨åœ°å›¾ä¸ŠæŸ¥çœ‹è¯¦ç»†è·¯çº¿','results.view_coupons':'æŸ¥çœ‹ä¼˜æƒ åˆ¸','map.title':'åœ¨åœ°å›¾ä¸Šç¡®è®¤è·¯çº¿',
        'coupon.title':'ä¼˜æƒ åˆ¸','coupon.detail':'ä¼˜æƒ åˆ¸è¯¦æƒ…','coupon.back_list':'è¿”å›åˆ—è¡¨','coupon.use':'ä½¿ç”¨','coupon.used':'å·²ä½¿ç”¨','coupon.confirm':'ç¡®å®šä½¿ç”¨è¯¥ä¼˜æƒ åˆ¸ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚',
        'nav.home':'é¦–é¡µ','nav.diagnosis':'è¯Šæ–­','nav.plan':'æ–¹æ¡ˆ','nav.map':'åœ°å›¾','nav.coupons':'ä¼˜æƒ åˆ¸',
        'steps.gender.title':'è¯·é€‰æ‹©æ‚¨çš„æ€§åˆ«','options.gender.male':'ç”·','options.gender.female':'å¥³','options.gender.other':'å…¶ä»–',
        'steps.age.title':'è¯·é€‰æ‹©æ‚¨çš„å¹´é¾„æ®µ','options.age.10s':'10å¤šå²','options.age.20s':'20å¤šå²','options.age.30s':'30å¤šå²','options.age.40s':'40å¤šå²','options.age.50s':'50å²ä»¥ä¸Š',
        'steps.mustVisit.title':'æœ‰å¿…é¡»å»çš„åŒºåŸŸå—ï¼Ÿ','options.mustVisit.enoshima':'æ±Ÿä¹‹å²›','options.mustVisit.kamakura':'é•°ä»“','options.mustVisit.both':'ä¸¤è€…','options.mustVisit.undecided':'æœªå†³å®š',
        'steps.travelStyle.title':'æ—…è¡Œé£æ ¼','options.travelStyle.relaxed':'è½»æ¾è§‚å…‰','options.travelStyle.active':'æ´»åŠ›æ¸¸ç©','options.travelStyle.cultural':'æ–‡åŒ–/å†å²','options.travelStyle.gourmet':'ç¾é£Ÿä¼˜å…ˆ',
        'steps.startLocation.title':'èµ·ç‚¹','options.startLocation.enoshima_station':'æ±Ÿä¹‹å²›ç«™','options.startLocation.kamakura_station':'é•°ä»“ç«™','options.startLocation.fujisawa_station':'è—¤æ³½ç«™','options.startLocation.other':'å…¶ä»–ï¼ˆè‡ªç”±è¾“å…¥ï¼‰',
        'steps.customStartLocation.title':'è‹¥ä¸ºå…¶ä»–ï¼Œè¯·è¾“å…¥èµ·ç‚¹','steps.startTime.title':'è¯·é€‰æ‹©å¼€å§‹æ—¶é—´','steps.endTime.title':'è¯·é€‰æ‹©è¿”å›æ—¶é—´',
        'steps.whatToDo.title':'æƒ³åšä»€ä¹ˆï¼ˆå¯é€‰ï¼‰','steps.customSpot.title':'æœ‰æƒ³å»çš„å…·ä½“åœ°ç‚¹å—ï¼ˆå¯é€‰ï¼‰',
        'placeholder.customStartLocation':'ä¾‹å¦‚ï¼šæ–°å®¿ç«™ã€æ¨ªæ»¨ã€å®¶åº­ä½å€','placeholder.whatToDo':'ä¾‹å¦‚ï¼šæ‹ç…§ã€ç¾é£Ÿã€å­¦ä¹ å†å²','placeholder.customSpot':'ä¾‹å¦‚ï¼šé•°ä»“æ–‡å­¦é¦†',
        'results.stay':'åœç•™æ—¶é—´','results.fee':'é—¨ç¥¨'
      },
      ko: {
        'app.title':'ì—ë…¸ì‹œë§ˆãƒ»ê°€ë§ˆì¿ ë¼','app.subtitle':'AI ê´€ê´‘ ë£¨íŠ¸ ìƒì„±','app.partners':'ì¶”ì˜¤ëŒ€í•™ ì˜¤ì¹´ì§€ë§ˆã‚¼ãƒŸ Ã— ê°€ë‚˜ê°€ì™€í˜„ ê´€ê´‘í˜‘íšŒ',
        'intro.about':'í”„ë¡œì íŠ¸ ì†Œê°œ','intro.lead':'ì„ í˜¸ì— ë§ì¶˜ ìµœì ì˜ ê´€ê´‘ ë£¨íŠ¸ë¥¼ ìë™ ìƒì„±í•©ë‹ˆë‹¤.',
        'intro.feature1.title':'AI ê°œì¸í™”','intro.feature1.desc':'ì§„ë‹¨ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë‹¹ì‹ ë§Œì˜ ê´€ê´‘ í”Œëœ ìƒì„±',
        'intro.feature2.title':'ì‹¤ì‹œê°„ ì²´í¬ì¸','intro.feature2.desc':'GPS ì—°ë™ìœ¼ë¡œ ë°©ë¬¸í•˜ê³  í¬ì¸íŠ¸ íšë“',
        'intro.feature3.title':'íŠ¹ì „ ì¿ í°','intro.feature3.desc':'ê´€ê´‘ì§€ì—ì„œ í• ì¸ ë° íŠ¹ì „ì„ ì¦‰ì‹œ íšë“',
        'intro.start':'AI ê´€ê´‘ ë£¨íŠ¸ ìƒì„± ì‹œì‘','diagnosis.progress':'ì§„í–‰ ìƒí™©','common.back':'ë’¤ë¡œ','common.next':'ë‹¤ìŒ','diagnosis.view_result':'ê²°ê³¼ ë³´ê¸°',
        'results.view_map':'ì§€ë„ì—ì„œ ìƒì„¸ ê²½ë¡œ ë³´ê¸°','results.view_coupons':'ì¿ í° ë³´ê¸°','map.title':'ì§€ë„ì—ì„œ ë£¨íŠ¸ í™•ì¸',
        'coupon.title':'ì¿ í°','coupon.detail':'ì¿ í° ìƒì„¸','coupon.back_list':'ëª©ë¡ìœ¼ë¡œ','coupon.use':'ì‚¬ìš©','coupon.used':'ì‚¬ìš©ë¨','coupon.confirm':'ì´ ì¿ í°ì„ ì‚¬ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ? í•œ ë²ˆ ì‚¬ìš©í•˜ë©´ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
        'nav.home':'í™ˆ','nav.diagnosis':'ì§„ë‹¨','nav.plan':'í”Œëœ','nav.map':'ì§€ë„','nav.coupons':'ì¿ í°',
        'steps.gender.title':'ì„±ë³„ì„ ì•Œë ¤ì£¼ì„¸ìš”','options.gender.male':'ë‚¨ì„±','options.gender.female':'ì—¬ì„±','options.gender.other':'ê¸°íƒ€',
        'steps.age.title':'ì—°ë ¹ëŒ€ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”','options.age.10s':'10ëŒ€','options.age.20s':'20ëŒ€','options.age.30s':'30ëŒ€','options.age.40s':'40ëŒ€','options.age.50s':'50ëŒ€ ì´ìƒ',
        'steps.mustVisit.title':'ê¼­ ê°€ê³  ì‹¶ì€ ê³³ì´ ìˆë‚˜ìš”?','options.mustVisit.enoshima':'ì—ë…¸ì‹œë§ˆ','options.mustVisit.kamakura':'ê°€ë§ˆì¿ ë¼','options.mustVisit.both':'ë‘˜ë‹¤','options.mustVisit.undecided':'ë¯¸ì •',
        'steps.travelStyle.title':'ì—¬í–‰ ìŠ¤íƒ€ì¼','options.travelStyle.relaxed':'ì—¬ìœ ë¡­ê²Œ','options.travelStyle.active':'í™œë™ì ìœ¼ë¡œ','options.travelStyle.cultural':'ë¬¸í™”ãƒ»ì—­ì‚¬ ì¤‘ì‹¬','options.travelStyle.gourmet':'ë¯¸ì‹ ì¤‘ì‹¬',
        'steps.startLocation.title':'ì¶œë°œì§€ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”','options.startLocation.enoshima_station':'ì—ë…¸ì‹œë§ˆ ì—­','options.startLocation.kamakura_station':'ê°€ë§ˆì¿ ë¼ ì—­','options.startLocation.fujisawa_station':'í›„ì§€ì‚¬ì™€ ì—­','options.startLocation.other':'ê¸°íƒ€ï¼ˆììœ  ì…ë ¥ï¼‰',
        'steps.customStartLocation.title':'ê¸°íƒ€ì˜ ê²½ìš° ì¶œë°œì§€ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”','steps.startTime.title':'ì¶œë°œ ì‹œê°„ì„ ì•Œë ¤ì£¼ì„¸ìš”','steps.endTime.title':'ëŒì•„ê°€ëŠ” ì‹œê°„ì„ ì•Œë ¤ì£¼ì„¸ìš”',
        'steps.whatToDo.title':'í•˜ê³  ì‹¶ì€ ê²ƒì„ ììœ ë¡­ê²Œ ì ì–´ì£¼ì„¸ìš”','steps.customSpot.title':'íŠ¹íˆ ê°€ê³  ì‹¶ì€ ì¥ì†Œê°€ ìˆë‹¤ë©´ ì ì–´ì£¼ì„¸ìš”',
        'placeholder.customStartLocation':'ì˜ˆ: ì‹ ì£¼ì¿ ì—­, ìš”ì½”í•˜ë§ˆ, ìíƒ ì£¼ì†Œ ë“±','placeholder.whatToDo':'ì˜ˆ: ì‚¬ì§„ ì°ê¸°, ë§›ì§‘ íƒë°©, ì—­ì‚¬ ë°°ìš°ê¸°','placeholder.customSpot':'ì˜ˆ: ê°€ë§ˆì¿ ë¼ ë¬¸í•™ê´€'
      }
    };

    function t(key){
      return (TEXTS[currentLang] && TEXTS[currentLang][key]) || (TEXTS['ja'][key] || '');
    }

    /* ===============
       DEMO_PLAN (same spots as before)
       and SPOT translations for all spots
       =============== */
    const DEMO_PLAN = [
      { id: "start-kamakura", name: "JRãƒ»æ±Ÿãƒé›» éŒå€‰é§…", description: "æ—…ã®ã‚¹ã‚¿ãƒ¼ãƒˆ", duration: 0, entrance_fee: 0, tags: ["ã‚¹ã‚¿ãƒ¼ãƒˆ"], tips: [], startTime: "10:00", endTime: "10:10", order: 1, lat: 35.3187, lng: 139.5503 },
      { id: "tsurugaoka", name: "é¶´å²¡å…«å¹¡å®®", description: "ã€æœ‰åã€‘ å‚æ‹", duration: 60, entrance_fee: 0, tags: ["ç¥ç¤¾","å‚æ‹"], tips: ["å‚é“ã®çœŸã‚“ä¸­ã¯ç¥æ§˜ã®é€šã‚Šé“ã€‚æ‰‹æ°´èˆã§èº«ã‚’æ¸…ã‚ã€ã€äºŒç¤¼äºŒæ‹æ‰‹ä¸€ç¤¼ã€ã§å‚æ‹ã€‚å¢ƒå†…ã§ã®é£Ÿäº‹ãƒ»ä¼‘æ†©ã¯ç¦æ­¢ã€‚"], startTime: "10:10", endTime: "11:10", order: 2, lat: 35.3259, lng: 139.5565 },
      { id: "komachidori", name: "å°ç”ºé€šã‚Š", description: "æ•£ç­–", duration: 30, entrance_fee: 0, tags: ["æ•£ç­–","å•†åº—è¡—"], tips: ["é£Ÿã¹æ­©ãã¯è‡ªç²›æ¨å¥¨ã€‚è³¼å…¥å“ã¯åº—èˆ—ã®æŒ‡å®šå ´æ‰€ã§ã„ãŸã ãã¾ã—ã‚‡ã†ã€‚"], startTime: "11:10", endTime: "11:40", order: 3, lat: 35.3215, lng: 139.5555 },
      { id: "to-wadazuka", name: "éŒå€‰é§… â†’ å’Œç”°å¡šé§…", description: "æ±Ÿãƒé›»ã§ç§»å‹•", duration: 10, entrance_fee: 0, tags: ["ç§»å‹•","æ±Ÿãƒé›»"], tips: [], startTime: "11:40", endTime: "11:50", order: 4, lat: 35.3136, lng: 139.5397 },
      { id: "wadazuka", name: "å’Œç”°å¡š", description: "ã€ãƒã‚¤ãƒŠãƒ¼ã€‘ å²è·¡è¦‹å­¦", duration: 20, entrance_fee: 0, tags: ["å²è·¡"], tips: ["é™ã‹ãªä½å®…è¡—ã€‚å¤§å£°ã‚’å‡ºã•ãšã€å²è·¡ã‚„æŸµã«è…°æ›ã‘ãªã„ã€‚"], startTime: "11:50", endTime: "12:10", order: 5, lat: 35.3136, lng: 139.5397 },
      { id: "hoshinoi", name: "æ˜Ÿã®äº• (ã»ã—ã®ã„)", description: "ã€ãƒ”ãƒ³ãƒã‚¤ãƒ³ãƒˆåº—ã€‘ æ˜¼é£Ÿï¼ˆãã°ï¼‰", duration: 60, entrance_fee: 0, tags: ["æ˜¼é£Ÿ","ãã°"], tips: ["è¦³å…‰å®¢ãŒå°‘ãªã„å ´æ‰€ã§ã‚†ã£ãã‚Šæ˜¼é£Ÿã«æœ€é©ã€‚é•·æ™‚é–“ã®é€šè©±ã¯æ§ãˆã‚ã«ã€‚"], startTime: "12:10", endTime: "13:10", order: 6, lat: 35.3130, lng: 139.5405 },
      { id: "to-hase", name: "å’Œç”°å¡šé§… â†’ é•·è°·é§…", description: "æ±Ÿãƒé›»ã§ç§»å‹•", duration: 10, entrance_fee: 0, tags: ["ç§»å‹•","æ±Ÿãƒé›»"], tips: [], startTime: "13:10", endTime: "13:20", order: 7, lat: 35.3127, lng: 139.5360 },
      { id: "mushinan", name: "ç„¡å¿ƒåºµ", description: "ã€ãƒ”ãƒ³ãƒã‚¤ãƒ³ãƒˆåº—ã€‘ ä¼‘æ†©ãƒ»ç”˜å‘³", duration: 60, entrance_fee: 0, tags: ["ç”˜å‘³","ä¼‘æ†©"], tips: ["åº—å†…ã‚„ç·šè·¯ä»˜è¿‘ã®æ’®å½±ã¯ä»–ã®ãŠå®¢æ§˜ã¨é›»è»Šã®å®‰å…¨ã«é…æ…®ã€‚"], startTime: "13:20", endTime: "14:20", order: 8, lat: 35.3124, lng: 139.5364 },
      { id: "kotokuin", name: "éŒå€‰å¤§ä»æ®¿ é«˜å¾³é™¢", description: "ã€æœ‰åã€‘ æ‹è¦³", duration: 60, entrance_fee: 300, tags: ["å¯ºé™¢","å¤§ä»"], tips: ["å¯ºé™¢ã¯æ‹æ‰‹ã›ãšé™ã‹ã«åˆæŒã—ä¸€ç¤¼ã€‚èƒå†…ã¯æ’®å½±ç¦æ­¢ã®å ´åˆã‚ã‚Šã€‚"], startTime: "14:20", endTime: "15:20", order: 9, lat: 35.3167, lng: 139.5353 },
      { id: "goryo", name: "å¾¡éœŠç¥ç¤¾ï¼ˆã”ã‚Šã‚‡ã†ã˜ã‚“ã˜ã‚ƒï¼‰", description: "ã€ãƒã‚¤ãƒŠãƒ¼ã€‘ å‚æ‹ãƒ»æ±Ÿãƒé›»æ’®å½±", duration: 40, entrance_fee: 0, tags: ["ç¥ç¤¾","æ’®å½±"], tips: ["ç·šè·¯å†…ç«‹å…¥ç¦æ­¢ã€‚è‡ªæ’®ã‚Šæ£’ãƒ»ä¸‰è„šç¦æ­¢ã€‚å¢ƒå†…ã¯æ’®å½±ç¦æ­¢ã®å ´åˆã‚ã‚Šã€‚"], startTime: "15:20", endTime: "16:00", order: 10, lat: 35.3139, lng: 139.5358 },
      { id: "to-inamura", name: "é•·è°·é§… â†’ ç¨²æ‘ãƒ¶å´é§…", description: "æ±Ÿãƒé›»ã§ç§»å‹•", duration: 10, entrance_fee: 0, tags: ["ç§»å‹•","æ±Ÿãƒé›»"], tips: [], startTime: "16:00", endTime: "16:10", order: 11, lat: 35.3094, lng: 139.5220 },
      { id: "inamuragasaki", name: "ç¨²æ‘ãƒ¶å´å…¬åœ’", description: "ã€ãƒã‚¤ãƒŠãƒ¼ãƒ“ãƒ¥ãƒ¼ã€‘ æ•£ç­–ãƒ»å†™çœŸæ’®å½±", duration: 40, entrance_fee: 0, tags: ["å…¬åœ’","å†™çœŸ"], tips: ["å¤•æ™¯ãŒç‰¹ã«ç¾ã—ã„ã€‚ã‚´ãƒŸã¯å¿…ãšæŒã¡å¸°ã‚‹ã€‚"], startTime: "16:10", endTime: "16:50", order: 12, lat: 35.3094, lng: 139.5220 },
      { id: "to-enoshima-st", name: "ç¨²æ‘ãƒ¶å´é§… â†’ æ±Ÿãƒå³¶é§…", description: "æ±Ÿãƒé›»ã§ç§»å‹•", duration: 15, entrance_fee: 0, tags: ["ç§»å‹•","æ±Ÿãƒé›»"], tips: [], startTime: "16:50", endTime: "17:05", order: 13, lat: 35.3058, lng: 139.4816 },
      { id: "walk-enoshima", name: "æ±Ÿãƒå³¶ã¸ç§»å‹•", description: "å¾’æ­©", duration: 30, entrance_fee: 0, tags: ["å¾’æ­©","ç§»å‹•"], tips: [], startTime: "17:05", endTime: "17:35", order: 14, lat: 35.3005, lng: 139.4802 },
      { id: "sea-candle", name: "ã‚µãƒ ã‚¨ãƒ«ãƒ»ã‚³ãƒƒã‚­ãƒ³ã‚°è‹‘ / ã‚·ãƒ¼ã‚­ãƒ£ãƒ³ãƒ‰ãƒ«", description: "ã€æœ‰åã€‘ å±•æœ›ãƒ»å¤•æ™¯", duration: 60, entrance_fee: 700, tags: ["å±•æœ›","å¤•æ™¯"], tips: ["ã‚¤ãƒ™ãƒ³ãƒˆæœŸé–“ã¯21:00ã¾ã§å»¶é•·ã‚ã‚Šã€‚ã‚¨ã‚¹ã‚«ãƒ¼åˆ©ç”¨ã§ä½“åŠ›æ¸©å­˜ã€‚"], startTime: "17:35", endTime: "18:35", order: 15, lat: 35.2986, lng: 139.4799 },
      { id: "iwaya", name: "æ±Ÿãƒå³¶å²©å±‹", description: "ã€ãƒã‚¤ãƒŠãƒ¼ã€‘ æ´çªŸä½“é¨“", duration: 50, entrance_fee: 500, tags: ["æ´çªŸ"], tips: ["å¤æœŸã¯18:00æœ€çµ‚å…¥å ´ã®å ´åˆã‚ã‚Šã€‚è¶³å…ƒã«æ³¨æ„ã€‚"], startTime: "18:35", endTime: "19:25", order: 16, lat: 35.2906, lng: 139.4780 },
      { id: "il-chianti", name: "ã‚¤ãƒ«ãƒ»ã‚­ãƒ£ãƒ³ãƒ†ã‚£", description: "ã€ãƒ”ãƒ³ãƒã‚¤ãƒ³ãƒˆåº—ã€‘ å¤•é£Ÿï¼ˆã‚¤ã‚¿ãƒªã‚¢ãƒ³ï¼‰", duration: 70, entrance_fee: 0, tags: ["å¤•é£Ÿ","ã‚¤ã‚¿ãƒªã‚¢ãƒ³"], tips: ["äººæ°—åº—ã®ãŸã‚äºˆç´„æ¨å¥¨ã€‚åŒã‚¨ãƒªã‚¢å†…ã§ç§»å‹•åŠ¹ç‡è‰¯ã€‚"], startTime: "19:25", endTime: "20:35", order: 17, lat: 35.3001, lng: 139.4793 },
      { id: "goal-enoshima", name: "æ±Ÿãƒå³¶é§…", description: "ã‚´ãƒ¼ãƒ«", duration: 0, entrance_fee: 0, tags: ["ã‚´ãƒ¼ãƒ«"], tips: ["å¸°è·¯ã¸ã€‚ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼"], startTime: "20:35", endTime: "20:35", order: 18, lat: 35.3058, lng: 139.4816 }
    ];

    // SPOT translations (complete mapping for these DEMO_PLAN IDs)
    const SPOT_I18N = {
      'start-kamakura': {
        name: { ja:'JRãƒ»æ±Ÿãƒé›» éŒå€‰é§…', en:'JR / Enoden Kamakura Station', zh:'JR / æ±Ÿä¹‹ç”µ é•°ä»“ç«™', ko:'JRãƒ»ì—ë…¸ë´ ê°€ë§ˆì¿ ë¼ì—­' },
        description: { ja:'æ—…ã®ã‚¹ã‚¿ãƒ¼ãƒˆ', en:'Start of the trip', zh:'æ—…ç¨‹å¼€å§‹', ko:'ì—¬í–‰ ì‹œì‘' },
        tips: { ja:[], en:[], zh:[], ko:[] }
      },
      'tsurugaoka': {
        name: { ja:'é¶´å²¡å…«å¹¡å®®', en:'Tsurugaoka Hachimangu Shrine', zh:'é¹¤å†ˆå…«å¹¡å®«', ko:'ì“°ë£¨ì˜¤ì¹´ í•˜ì¹˜ë§Œêµ¬' },
        description: { ja:'ã€æœ‰åã€‘ å‚æ‹', en:'[Famous] Shrine visit', zh:'ã€æœ‰åã€‘ å‚æ‹œ', ko:'ã€ìœ ëª…ã€‘ ì°¸ë°°' },
        tips: {
          ja:['å‚é“ã®çœŸã‚“ä¸­ã¯ç¥æ§˜ã®é€šã‚Šé“ã€‚æ‰‹æ°´èˆã§æ¸…ã‚ã€ã€ŒäºŒç¤¼äºŒæ‹æ‰‹ä¸€ç¤¼ã€ã§å‚æ‹ã€‚å¢ƒå†…ã§ã®é£²é£Ÿã¯ä¸å¯ã€‚'],
          en:['Do not walk in the center of the approach. Purify at the water basin; bow twice, clap twice, bow once. No eating/resting inside the grounds.'],
          zh:['å‚é“ä¸­å¤®ä¸ºç¥é“ï¼Œè¯·åœ¨æ‰‹æ°´èˆå‡€æ‰‹ï¼›â€œäºŒæ‹œäºŒæ‹æ‰‹ä¸€æ‹œâ€ã€‚å¢ƒå†…ç¦æ­¢é¥®é£Ÿä¼‘æ†©ã€‚'],
          ko:['ì°¸ë„ ì¤‘ì•™ì€ ì‹ ì˜ ê¸¸ì…ë‹ˆë‹¤. ì†ì„ ì”»ê³  â€œë‘ ë²ˆ ì¸ì‚¬, ë‘ ë²ˆ ë°•ìˆ˜, í•œ ë²ˆ ì¸ì‚¬â€ë¡œ ì°¸ë°°í•˜ì„¸ìš”. ê²½ë‚´ì—ì„œì˜ ìŒì‹ ì„­ì·¨ ê¸ˆì§€.']
        }
      },
      'komachidori': {
        name: { ja:'å°ç”ºé€šã‚Š', en:'Komachi Street', zh:'å°ç”ºé€š', ko:'ì½”ë§ˆì¹˜ ê±°ë¦¬' },
        description: { ja:'æ•£ç­–', en:'Stroll', zh:'æ•£æ­¥', ko:'ì‚°ì±…' },
        tips: {
          ja:['é£Ÿã¹æ­©ãã¯è‡ªç²›æ¨å¥¨ã€‚è³¼å…¥å“ã¯åº—èˆ—ã®æŒ‡å®šå ´æ‰€ã§ã€‚'],
          en:['Refrain from eating while walking. Eat at designated spots.'],
          zh:['å»ºè®®é¿å…è¾¹èµ°è¾¹åƒï¼Œè¯·åœ¨åº—é“ºæŒ‡å®šå¤„ç”¨é¤ã€‚'],
          ko:['ìŒì‹ì„ ë“¤ê³  ê±¸ì–´ ë¨¹ì§€ ì•ŠëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤. ì§€ì •ëœ ì¥ì†Œì—ì„œ ë“œì„¸ìš”.']
        }
      },
      'to-wadazuka': {
        name: { ja:'éŒå€‰é§… â†’ å’Œç”°å¡šé§…', en:'Kamakura â†’ Wadazuka (Enoden)', zh:'é•°ä»“ç«™ â†’ å’Œç”°å¡šç«™', ko:'ê°€ë§ˆì¿ ë¼ì—­ â†’ ì™€ë‹¤ì¦ˆì¹´ì—­ (ì—ë…¸ë´)' },
        description: { ja:'æ±Ÿãƒé›»ã§ç§»å‹•', en:'Move by Enoden (train)', zh:'æ­ä¹˜æ±Ÿä¹‹ç”µç§»åŠ¨', ko:'ì—ë…¸ë´ìœ¼ë¡œ ì´ë™' },
        tips: { ja:[], en:[], zh:[], ko:[] }
      },
      'wadazuka': {
        name: { ja:'å’Œç”°å¡š', en:'Wadazuka', zh:'å’Œç”°å¡š', ko:'ì™€ë‹¤ì¦ˆì¹´' },
        description: { ja:'ã€ãƒã‚¤ãƒŠãƒ¼ã€‘ å²è·¡è¦‹å­¦', en:'[Lesser-known] Historical site visit', zh:'ã€ååƒ»ã€‘ å²è¿¹å‚è§‚', ko:'ã€ì†Œê·œëª¨ã€‘ ì‚¬ì  ê´€ëŒ' },
        tips: {
          ja:['é™ã‹ãªä½å®…è¡—ã€‚å¤§å£°ã‚’å‡ºã•ãšã€å²è·¡ã‚„æŸµã«è…°æ›ã‘ãªã„ã€‚'],
          en:['Quiet residential area. Keep noise down and do not sit on ruins or fences.'],
          zh:['å®‰é™çš„ä½å®…åŒºï¼Œè¯·ä¿æŒå®‰é™å¹¶å‹¿ååœ¨å²è¿¹æˆ–æ æ†ä¸Šã€‚'],
          ko:['ì¡°ìš©í•œ ì£¼íƒê°€ì…ë‹ˆë‹¤. í° ì†Œë¦¬ë¥¼ ë‚´ì§€ ë§ê³  ìœ ì ì´ë‚˜ ìš¸íƒ€ë¦¬ì— ì•‰ì§€ ë§ˆì„¸ìš”.']
        }
      },
      'hoshinoi': {
        name: { ja:'æ˜Ÿã®äº• (ã»ã—ã®ã„)', en:'Hoshinoi (Soba)', zh:'æ˜Ÿä¹‹äº•ï¼ˆèéº¦é¢ï¼‰', ko:'í˜¸ì‹œë…¸ì´ (ì†Œë°”)' },
        description: { ja:'æ˜¼é£Ÿï¼ˆãã°ï¼‰', en:'Lunch (soba)', zh:'åˆé¤ï¼ˆèéº¦é¢ï¼‰', ko:'ì ì‹¬ (ì†Œë°”)' },
        tips: {
          ja:['è¦³å…‰å®¢ãŒå°‘ãªã„å ´æ‰€ã§ã‚†ã£ãã‚Šæ˜¼é£Ÿã«æœ€é©ã€‚é•·æ™‚é–“ã®é€šè©±ã¯æ§ãˆã‚ã«ã€‚'],
          en:['A quiet spot suitable for a relaxed lunch. Please avoid long phone conversations.'],
          zh:['é€‚åˆæ‚ é—²åˆé¤çš„å®‰é™åœ°ç‚¹ï¼Œè¯·é¿å…é•¿æ—¶é—´é€šè¯ã€‚'],
          ko:['ê´€ê´‘ê°ì´ ì ì€ í¸ìœ¼ë¡œ ì—¬ìœ ë¡­ê²Œ ì ì‹¬ ë¨¹ê¸° ì¢‹ìŠµë‹ˆë‹¤. ì¥ì‹œê°„ í†µí™” ìì œ ê¶Œì¥.']
        }
      },
      'to-hase': {
        name: { ja:'å’Œç”°å¡šé§… â†’ é•·è°·é§…', en:'Wadazuka â†’ Hase (Enoden)', zh:'å’Œç”°å¡šç«™ â†’ é•¿è°·ç«™', ko:'ì™€ë‹¤ì¦ˆì¹´ì—­ â†’ í•˜ì„¸ì—­ (ì—ë…¸ë´)' },
        description: { ja:'æ±Ÿãƒé›»ã§ç§»å‹•', en:'Move by Enoden (train)', zh:'æ­ä¹˜æ±Ÿä¹‹ç”µç§»åŠ¨', ko:'ì—ë…¸ë´ìœ¼ë¡œ ì´ë™' },
        tips: { ja:[], en:[], zh:[], ko:[] }
      },
      'mushinan': {
        name: { ja:'ç„¡å¿ƒåºµ', en:'Mushinan (Cafe)', zh:'æ— å¿ƒåºµï¼ˆèŒ¶é¦†ï¼‰', ko:'ë¬´ì‹ ì•ˆ (ì¹´í˜)' },
        description: { ja:'ä¼‘æ†©ãƒ»ç”˜å‘³', en:'Rest / Sweets', zh:'ä¼‘æ¯ãƒ»ç”œç‚¹', ko:'íœ´ì‹ãƒ»ë‹¨ê³¼' },
        tips: {
          ja:['åº—å†…ã‚„ç·šè·¯ä»˜è¿‘ã®æ’®å½±ã¯ä»–ã®ãŠå®¢æ§˜ã¨é›»è»Šã®å®‰å…¨ã«é…æ…®ã€‚'],
          en:['When photographing, be mindful of other customers and train safety near tracks.'],
          zh:['æ‹ç…§æ—¶è¯·æ³¨æ„å…¶ä»–é¡¾å®¢ä¸é“é“å®‰å…¨ã€‚'],
          ko:['ë‚´ë¶€ ë° ì„ ë¡œ ê·¼ì²˜ ì´¬ì˜ ì‹œ ë‹¤ë¥¸ ê³ ê° ë° ì—´ì°¨ ì•ˆì „ì„ ìœ ì˜í•˜ì„¸ìš”.']
        }
      },
      'kotokuin': {
        name: { ja:'éŒå€‰å¤§ä»æ®¿ é«˜å¾³é™¢', en:'Kamakura Daibutsu (Kotoku-in)', zh:'é•°ä»“å¤§ä½›æ®¿ é«˜å¾·é™¢', ko:'ê°€ë§ˆì¿ ë¼ ëŒ€ë¶ˆ ê³ í† ì¿ ì¸' },
        description: { ja:'æ‹è¦³', en:'Temple viewing', zh:'å‚è§‚', ko:'ì°¸ë°°' },
        tips: {
          ja:['å¯ºé™¢ã¯æ‹æ‰‹ã›ãšé™ã‹ã«åˆæŒã—ä¸€ç¤¼ã€‚èƒå†…ã¯æ’®å½±ç¦æ­¢ã®å ´åˆã‚ã‚Šã€‚'],
          en:['At temples, do not clap; quietly put hands together and bow. Interior photography may be restricted.'],
          zh:['åœ¨å¯ºé™¢è¯·å®‰é™åˆåè‡´ç¤¼ï¼Œèƒå†…æ‹ç…§å¯èƒ½è¢«ç¦æ­¢ã€‚'],
          ko:['ì‚¬ì›ì—ì„œëŠ” ë°•ìˆ˜ ëŒ€ì‹  í•©ì¥ í›„ ê³ ê°œ ìˆ™ì—¬ ì°¸ë°°í•˜ì„¸ìš”. ë‚´ë¶€ ì´¬ì˜ ê¸ˆì§€ì¼ ìˆ˜ ìˆìŒ.']
        }
      },
      'goryo': {
        name: { ja:'å¾¡éœŠç¥ç¤¾ï¼ˆã”ã‚Šã‚‡ã†ã˜ã‚“ã˜ã‚ƒï¼‰', en:'Goryo Shrine', zh:'å¾¡çµç¥ç¤¾', ko:'ê³ ë£Œ ì‹ ì‚¬' },
        description: { ja:'å‚æ‹ãƒ»æ±Ÿãƒé›»æ’®å½±', en:'Shrine visit & Enoden photo spot', zh:'å‚æ‹œãƒ»æ±Ÿä¹‹ç”µæ‹ç…§ç‚¹', ko:'ì°¸ë°°ãƒ»ì—ë…¸ë´ ì´¬ì˜ í¬ì¸íŠ¸' },
        tips: {
          ja:['ç·šè·¯å†…ç«‹å…¥ç¦æ­¢ã€‚è‡ªæ’®ã‚Šæ£’ãƒ»ä¸‰è„šç¦æ­¢ã€‚å¢ƒå†…ã¯æ’®å½±ç¦æ­¢ã®å ´åˆã‚ã‚Šã€‚'],
          en:['Do not enter the tracks. Selfie sticks and tripods are prohibited. Some areas may forbid photography.'],
          zh:['ç¦æ­¢è¿›å…¥é“è½¨ã€‚ç¦æ­¢ä½¿ç”¨è‡ªæ‹æ†ä¸ä¸‰è„šæ¶ã€‚å¢ƒå†…éƒ¨åˆ†åŒºåŸŸå¯èƒ½ç¦æ­¢æ‹ç…§ã€‚'],
          ko:['ì„ ë¡œ ì¹¨ì… ê¸ˆì§€. ì…€ì¹´ë´‰ ë° ì‚¼ê°ëŒ€ ê¸ˆì§€. ê²½ë‚´ ì¼ë¶€ ì´¬ì˜ ê¸ˆì§€ì¼ ìˆ˜ ìˆìŒ.']
        }
      },
      'to-inamura': {
        name: { ja:'é•·è°·é§… â†’ ç¨²æ‘ãƒ¶å´é§…', en:'Hase â†’ Inamuragasaki (Enoden)', zh:'é•¿è°·ç«™ â†’ ç¨»æ‘å´ç«™', ko:'í•˜ì„¸ì—­ â†’ ì´ë‚˜ë¬´ë¼ê°€ì‚¬í‚¤ì—­ (ì—ë…¸ë´)' },
        description: { ja:'æ±Ÿãƒé›»ã§ç§»å‹•', en:'Move by Enoden (train)', zh:'æ­ä¹˜æ±Ÿä¹‹ç”µç§»åŠ¨', ko:'ì—ë…¸ë´ìœ¼ë¡œ ì´ë™' },
        tips: { ja:[], en:[], zh:[], ko:[] }
      },
      'inamuragasaki': {
        name: { ja:'ç¨²æ‘ãƒ¶å´å…¬åœ’', en:'Inamuragasaki Park', zh:'ç¨»æ‘å´å…¬å›­', ko:'ì´ë‚˜ë¬´ë¼ê°€ì‚¬í‚¤ ê³µì›' },
        description: { ja:'æ•£ç­–ãƒ»å†™çœŸæ’®å½±', en:'Stroll & photo spot', zh:'æ•£æ­¥ãƒ»æ‹ç…§', ko:'ì‚°ì±…ãƒ»ì‚¬ì§„ ì´¬ì˜' },
        tips: {
          ja:['å¤•æ™¯ãŒç‰¹ã«ç¾ã—ã„ã€‚ã‚´ãƒŸã¯å¿…ãšæŒã¡å¸°ã‚‹ã€‚'],
          en:['The sunset view is particularly beautiful. Please take your trash home.'],
          zh:['å¤•æ™¯å°¤ä¸ºç¾ä¸½ï¼Œè¯·åŠ¡å¿…å¸¦èµ°åƒåœ¾ã€‚'],
          ko:['ì„ì–‘ ê²½ì¹˜ê°€ ì•„ë¦„ë‹µìŠµë‹ˆë‹¤. ì“°ë ˆê¸°ëŠ” ë°˜ë“œì‹œ ê°€ì ¸ê°€ì„¸ìš”.']
        }
      },
      'to-enoshima-st': {
        name: { ja:'ç¨²æ‘ãƒ¶å´é§… â†’ æ±Ÿãƒå³¶é§…', en:'Inamuragasaki â†’ Enoshima (Enoden)', zh:'ç¨»æ‘å´ç«™ â†’ æ±Ÿä¹‹å²›ç«™', ko:'ì´ë‚˜ë¬´ë¼ê°€ì‚¬í‚¤ì—­ â†’ ì—ë…¸ì‹œë§ˆì—­ (ì—ë…¸ë´)' },
        description: { ja:'æ±Ÿãƒé›»ã§ç§»å‹•', en:'Move by Enoden (train)', zh:'æ­ä¹˜æ±Ÿä¹‹ç”µç§»åŠ¨', ko:'ì—ë…¸ë´ìœ¼ë¡œ ì´ë™' },
        tips: { ja:[], en:[], zh:[], ko:[] }
      },
      'walk-enoshima': {
        name: { ja:'æ±Ÿãƒå³¶ã¸ç§»å‹•', en:'Walk to Enoshima', zh:'æ­¥è¡Œå‰å¾€æ±Ÿä¹‹å²›', ko:'ì—ë…¸ì‹œë§ˆê¹Œì§€ ë„ë³´ ì´ë™' },
        description: { ja:'å¾’æ­©', en:'Walk', zh:'æ­¥è¡Œ', ko:'ë„ë³´' },
        tips: { ja:[], en:[], zh:[], ko:[] }
      },
      'sea-candle': {
        name: { ja:'ã‚µãƒ ã‚¨ãƒ«ãƒ»ã‚³ãƒƒã‚­ãƒ³ã‚°è‹‘ / ã‚·ãƒ¼ã‚­ãƒ£ãƒ³ãƒ‰ãƒ«', en:'Samuel Cocking Garden / Sea Candle', zh:'å¡ç¼ªå°”Â·è€ƒé‡‘è‹‘ / æµ·çƒ›å¡”', ko:'ì‚¬ë¬´ì—˜ ì½”í‚¹ ì •ì› / ì”¨ ìº”ë“¤' },
        description: { ja:'å±•æœ›ãƒ»å¤•æ™¯', en:'Observation & sunset', zh:'è§‚æ™¯ãƒ»å¤•æ™¯', ko:'ì „ë§ãƒ»ì„ì–‘' },
        tips: {
          ja:['ã‚¤ãƒ™ãƒ³ãƒˆæœŸé–“ã¯21:00ã¾ã§å»¶é•·ã‚ã‚Šã€‚ã‚¨ã‚¹ã‚«ãƒ¼åˆ©ç”¨ã§ä½“åŠ›æ¸©å­˜ã€‚'],
          en:['During events it may be open until 21:00. Use the Escar to save energy.'],
          zh:['æ´»åŠ¨æœŸé—´å¯èƒ½å¼€æ”¾è‡³21:00ã€‚å¯ä½¿ç”¨ç”µæ¢¯èŠ‚çœä½“åŠ›ã€‚'],
          ko:['ì´ë²¤íŠ¸ ê¸°ê°„ì—ëŠ” 21:00ê¹Œì§€ ì—°ì¥ë˜ëŠ” ê²½ìš°ê°€ ìˆìŠµë‹ˆë‹¤. ì—ìŠ¤ì¹´ë¥¼ ì´ìš©í•´ ì²´ë ¥ ì ˆì•½.']
        }
      },
      'iwaya': {
        name: { ja:'æ±Ÿãƒå³¶å²©å±‹', en:'Enoshima Iwaya Caves', zh:'æ±Ÿä¹‹å²›å²©å±‹ï¼ˆæ´çªŸï¼‰', ko:'ì—ë…¸ì‹œë§ˆ ì´ì™€ì•¼ (ë™êµ´)' },
        description: { ja:'æ´çªŸä½“é¨“', en:'Cave experience', zh:'æ´ç©´ä½“éªŒ', ko:'ë™êµ´ ì²´í—˜' },
        tips: {
          ja:['å¤æœŸã¯18:00æœ€çµ‚å…¥å ´ã®å ´åˆã‚ã‚Šã€‚è¶³å…ƒã«æ³¨æ„ã€‚'],
          en:['In summer last entry may be 18:00. Watch your step.'],
          zh:['å¤å­£æœ€æ™šå…¥åœºå¯èƒ½ä¸º18:00ï¼Œè¯·æ³¨æ„è„šä¸‹å®‰å…¨ã€‚'],
          ko:['ì—¬ë¦„ì—ëŠ” ìµœì¢… ì…ì¥ì´ 18:00ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë°œë°‘ ì£¼ì˜í•˜ì„¸ìš”.']
        }
      },
      'il-chianti': {
        name: { ja:'ã‚¤ãƒ«ãƒ»ã‚­ãƒ£ãƒ³ãƒ†ã‚£', en:'Il Chianti (Italian)', zh:'ã‚¤ãƒ«ãƒ»ã‚­ãƒ£ãƒ³ãƒ†ã‚£ï¼ˆæ„å¤§åˆ©é¤å…ï¼‰', ko:'ì¼ í‚¨í‹° (ì´íƒˆë¦¬ì•ˆ)' },
        description: { ja:'å¤•é£Ÿï¼ˆã‚¤ã‚¿ãƒªã‚¢ãƒ³ï¼‰', en:'Dinner (Italian)', zh:'æ™šé¤ï¼ˆæ„å¤§åˆ©èœï¼‰', ko:'ì €ë… (ì´íƒˆë¦¬ì•ˆ)' },
        tips: {
          ja:['äººæ°—åº—ã®ãŸã‚äºˆç´„æ¨å¥¨ã€‚åŒã‚¨ãƒªã‚¢å†…ã§ç§»å‹•åŠ¹ç‡è‰¯ã€‚'],
          en:['Popular spotâ€”reservation recommended. Efficient within this area.'],
          zh:['äººæ°”åº—é“ºï¼Œå»ºè®®é¢„çº¦ã€‚åŒºåŸŸå†…ç§»åŠ¨æ•ˆç‡è‰¯å¥½ã€‚'],
          ko:['ì¸ê¸° ê°€ê²Œë¡œ ì˜ˆì•½ ê¶Œì¥. ë™ì§€ì—­ ë‚´ ì´ë™ íš¨ìœ¨ì .']
        }
      },
      'goal-enoshima': {
        name: { ja:'æ±Ÿãƒå³¶é§…', en:'Enoshima Station', zh:'æ±Ÿä¹‹å²›ç«™', ko:'ì—ë…¸ì‹œë§ˆì—­' },
        description: { ja:'ã‚´ãƒ¼ãƒ«', en:'Goal / End', zh:'ç»ˆç‚¹', ko:'ê³¨' },
        tips: { ja:['å¸°è·¯ã¸ã€‚ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼'], en:['Return home. Thanks for traveling!'], zh:['è¿”å›ã€‚æ—…é€”æ„‰å¿«ï¼'], ko:['ê·€ê°€ ê²½ë¡œë¡œ ì´ë™. ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤!'] }
      }
    };

    // Demo coupons
    const DEMO_COUPONS = [
      { id: "c1", title: {ja:"ã‚¨ã‚¹ã‚«ãƒ¼å‰²å¼•åˆ¸",en:"Escar Discount",zh:"ç”µæ‰¶æ¢¯æŠ˜æ‰£åˆ¸",ko:"ì—ìŠ¤ì¹´ í• ì¸ê¶Œ"}, description: {ja:"ã‚¨ã‚¹ã‚«ãƒ¼åˆ©ç”¨æ–™é‡‘10%OFF",en:"10% off Escar fee",zh:"ç”µæ‰¶æ¢¯è´¹ç”¨9æŠ˜",ko:"ì—ìŠ¤ì¹´ ì´ìš© ìš”ê¸ˆ 10% í• ì¸"}, discount: "10%OFF", validUntil: "2025-12-31", spotName: "æ±Ÿå³¶ç¥ç¤¾", used: false },
      { id: "c2", title: {ja:"ã‚»ãƒƒãƒˆåˆ¸å‰²å¼•",en:"Set Ticket Discount",zh:"å¥—ç¥¨æŠ˜æ‰£",ko:"ì„¸íŠ¸ê¶Œ í• ì¸"}, description: {ja:"ã‚·ãƒ¼ã‚­ãƒ£ãƒ³ãƒ‰ãƒ«ï¼‹ã‚³ãƒƒã‚­ãƒ³ã‚°è‹‘100å††OFF",en:"100 JPY off Sea Candle + Garden",zh:"æµ·çƒ›å¡”+è€ƒé‡‘è‹‘å‡100æ—¥å…ƒ",ko:"ì”¨ìº”ë“¤+ê°€ë“  100ì—” í• ì¸"}, discount: "Â¥100OFF", validUntil: "2025-12-31", spotName: "æ±Ÿãƒå³¶ã‚·ãƒ¼ã‚­ãƒ£ãƒ³ãƒ‰ãƒ«", used: false }
    ];

    // STEPS (preserve original order & keys)
    const STEPS = [
      { title: "steps.gender.title", key: "gender", options: [{value:"male",label:"options.gender.male"},{value:"female",label:"options.gender.female"},{value:"other",label:"options.gender.other"}] },
      { title: "steps.age.title", key: "age", options: [{value:"10s",label:"options.age.10s"},{value:"20s",label:"options.age.20s"},{value:"30s",label:"options.age.30s"},{value:"40s",label:"options.age.40s"},{value:"50s",label:"options.age.50s"}] },
      { title: "steps.mustVisit.title", key: "mustVisit", options: [{value:"enoshima",label:"options.mustVisit.enoshima"},{value:"kamakura",label:"options.mustVisit.kamakura"},{value:"both",label:"options.mustVisit.both"},{value:"undecided",label:"options.mustVisit.undecided"}] },
      { title: "steps.travelStyle.title", key: "travelStyle", options: [{value:"relaxed",label:"options.travelStyle.relaxed"},{value:"active",label:"options.travelStyle.active"},{value:"cultural",label:"options.travelStyle.cultural"},{value:"gourmet",label:"options.travelStyle.gourmet"}] },
      { title: "steps.startLocation.title", key: "startLocation", options: [{value:"enoshima_station",label:"options.startLocation.enoshima_station"},{value:"kamakura_station",label:"options.startLocation.kamakura_station"},{value:"fujisawa_station",label:"options.startLocation.fujisawa_station"},{value:"other",label:"options.startLocation.other"}] },
      { title: "steps.customStartLocation.title", key: "customStartLocation", isCustomInput: true, condition: (d)=>d.startLocation === 'other' },
      { title: "steps.startTime.title", key: "startTime", isTimeInput: true },
      { title: "steps.endTime.title", key: "endTime", isTimeInput: true },
      { title: "steps.whatToDo.title", key: "whatToDo", isCustomInput: true, isOptional: true },
      { title: "steps.customSpot.title", key: "customSpot", isCustomInput: true, isOptional: true }
    ];

    let currentStep = 0;
    let diagnosisData = {};
    let mapInstance = null;
    let mapReady = false;

    /* ---------- Utilities ---------- */
    function escapeHtml(str){ if(!str) return ''; return String(str).replace(/[&<>"'`=\/]/g, function(s){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'})[s]; }); }

    /* ---------- i18n apply ---------- */
    function applyI18n(){
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const key = el.getAttribute('data-i18n');
        const txt = t(key);
        if(txt) el.textContent = txt;
      });
      // update dynamic next button text
      const nextBtn = document.getElementById('next-btn');
      if(nextBtn) nextBtn.textContent = (STEPS && STEPS.length) ? (currentStep === STEPS.length - 1 ? t('diagnosis.view_result') : t('common.next')) : t('common.next');
    }

    /* ---------- Screen control (preserve structure) ---------- */
    function showScreen(name){
      const screens = ['intro-screen','diagnosis-screen','loading-screen','results-screen','map-screen','coupons-screen','coupon-detail-screen'];
      screens.forEach(id=>{ const el=document.getElementById(id); if(el) el.classList.add('hidden'); });
      if(name === 'results') document.getElementById('results-screen').classList.remove('hidden');
      else if(name === 'intro') document.getElementById('intro-screen').classList.remove('hidden');
      else if(name === 'diagnosis') document.getElementById('diagnosis-screen').classList.remove('hidden');
      else if(name === 'map') { document.getElementById('map-screen').classList.remove('hidden'); if(!mapReady) initMap(); }
      else if(name === 'coupons') document.getElementById('coupons-screen').classList.remove('hidden');
      else if(name === 'coupon-detail') document.getElementById('coupon-detail-screen').classList.remove('hidden');

      const nav = document.getElementById('nav-bar');
      if(name === 'intro') nav.classList.add('hidden'); else nav.classList.remove('hidden');
    }

    function startDiagnosis(){
      showScreen('diagnosis');
      const total = document.getElementById('total-steps');
      if(total) total.textContent = String(STEPS.length);
      currentStep = 0;
      diagnosisData = {};
      renderQuestion();
      applyI18n();
    }

    /* ---------- Render Questions (unchanged semantics) ---------- */
    function renderQuestion(){
      if(currentStep < 0) currentStep = 0;
      if(currentStep >= STEPS.length) return;
      const step = STEPS[currentStep];
      if(step.condition && !step.condition(diagnosisData)){ currentStep++; return renderQuestion(); }
      document.getElementById('question-title').textContent = t(step.title) || step.title;
      document.getElementById('step-number').textContent = currentStep + 1;
      document.getElementById('step-progress').textContent = currentStep + 1;
      document.getElementById('progress-bar').style.width = (((currentStep + 1) / STEPS.length) * 100) + '%';
      const content = document.getElementById('question-content');
      content.innerHTML = '';

      if(step.isCustomInput){
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'w-full h-12 rounded-2xl border-2 border-gray-200 focus:border-sky-500 transition-colors px-4';
        const phMap = { customStartLocation: 'placeholder.customStartLocation', whatToDo: 'placeholder.whatToDo', customSpot: 'placeholder.customSpot' };
        const phKey = phMap[step.key] || '';
        input.placeholder = phKey ? t(phKey) : '';
        input.value = diagnosisData[step.key] || '';
        input.oninput = (e) => { diagnosisData[step.key] = e.target.value; updateNextButton(); };
        content.appendChild(input);
        const p = document.createElement('p'); p.className = 'text-xs text-gray-500 text-center mt-4'; p.textContent = step.isOptional ? 'ï¼ˆä»»æ„é …ç›®ï¼‰ç©ºæ¬„ã§ã‚‚ææ¡ˆã—ã¾ã™' : 'è‡ªç”±ã«å…¥åŠ›ã—ã¦ãã ã•ã„'; content.appendChild(p);
      } else if(step.isTimeInput){
        const input = document.createElement('input');
        input.type = 'time';
        input.className = 'w-full h-12 rounded-2xl border-2 border-gray-200 focus:border-sky-500 transition-colors text-center text-lg';
        input.value = diagnosisData[step.key] || '';
        input.onchange = (e)=>{ diagnosisData[step.key] = e.target.value; updateNextButton(); };
        content.appendChild(input);
      } else {
        const group = document.createElement('div'); group.className = 'space-y-3';
        step.options.forEach(opt=>{
          const label = document.createElement('label');
          label.className = 'option-label flex items-center space-x-4 p-4 rounded-2xl border-2 border-gray-200 hover:border-sky-300 hover:bg-sky-50 cursor-pointer transition-all duration-200';
          const radio = document.createElement('input'); radio.type = 'radio'; radio.name = step.key; radio.value = opt.value; radio.className = 'sr-only';
          if(diagnosisData[step.key] === opt.value) radio.checked = true;
          radio.onchange = ()=>{ diagnosisData[step.key] = opt.value; updateNextButton(); markActiveLabel(radio); };
          const inner = document.createElement('div'); inner.className = 'option-inner flex-1';
          inner.innerHTML = `<div class="flex justify-between items-center"><div class="text-sm font-medium">${t(opt.label)}</div><div class="text-xs text-gray-500"> </div></div>`;
          label.appendChild(radio); label.appendChild(inner); group.appendChild(label);
          label.addEventListener('click',()=>{ radio.checked = true; radio.dispatchEvent(new Event('change')); });
        });
        content.appendChild(group);
      }

      document.getElementById('back-btn').classList.toggle('hidden', currentStep === 0);
      updateNextButton();
      applyI18n();
    }

    function markActiveLabel(radio){
      document.querySelectorAll(`label.option-label`).forEach(lbl=>lbl.classList.remove('active'));
      const lbl = radio.closest('label.option-label');
      if(lbl) lbl.classList.add('active');
    }

    function updateNextButton(){
      const step = STEPS[currentStep];
      const next = document.getElementById('next-btn');
      if(!next) return;
      let enabled = false;
      if(step.isCustomInput){
        if(step.isOptional) enabled = true;
        else enabled = !!(diagnosisData[step.key] && diagnosisData[step.key].trim().length>0);
      } else if(step.isTimeInput){
        enabled = !!diagnosisData[step.key];
      } else {
        enabled = !!diagnosisData[step.key];
      }
      next.disabled = !enabled;
      next.classList.toggle('opacity-50', !enabled);
      next.textContent = currentStep === STEPS.length - 1 ? t('diagnosis.view_result') : t('common.next');
    }

    function nextStep(){
      const step = STEPS[currentStep];
      if(!step) return;
      const isOptional = step.isOptional;
      if(!isOptional && !diagnosisData[step.key] && !step.isTimeInput && !step.isCustomInput) return;
      if(currentStep >= STEPS.length - 1){
        showScreen('loading');
        setTimeout(()=>{ showResults(); }, 900);
        return;
      }
      currentStep++;
      renderQuestion();
    }

    function previousStep(){ if(currentStep <= 0) return; currentStep--; renderQuestion(); }

    /* ===========================
       Check-in state & lottery
       - uses localStorage to persist checked spots (per-plan)
       - distance threshold: 300m
       - lottery enabled when >= 80% spots checked (non-move items)
       =========================== */
    const CHECKIN_KEY = 'demo_checkins_v1';
    const CHECKIN_THRESHOLD_M = 300; // 300 meters
    const LOTTERY_RATE = 0.8;

    function loadCheckins(){
      try{ const raw = localStorage.getItem(CHECKIN_KEY); return raw ? JSON.parse(raw) : {}; } catch(e){ return {}; }
    }
    function saveCheckins(obj){ try{ localStorage.setItem(CHECKIN_KEY, JSON.stringify(obj)); }catch(e){} }

    function markSpotAsChecked(spotId){
      const cs = loadCheckins();
      cs[spotId] = true;
      saveCheckins(cs);
      updateCheckinUI();
    }
    function isChecked(spotId){
      const cs = loadCheckins();
      return !!cs[spotId];
    }
    function resetCheckins(){
      saveCheckins({});
      updateCheckinUI();
    }

    function getDistance(lat1, lon1, lat2, lon2){
      // Haversine in meters
      const R = 6371000;
      const toRad = v => v * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)*Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function tryCheckIn(spot){
      if(!navigator.geolocation) return alert(t('geo.unavailable') || 'ä½ç½®æƒ…å ±ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
      navigator.geolocation.getCurrentPosition(pos=>{
        const lat = pos.coords.latitude, lon = pos.coords.longitude;
        const dist = getDistance(lat, lon, spot.lat, spot.lng);
        if(dist <= CHECKIN_THRESHOLD_M){
          markSpotAsChecked(spot.id);
          alert(t('checkin.success') || 'ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³æˆåŠŸï¼ğŸ‰');
        } else {
          alert((t('checkin.too_far') || 'ã‚‚ã†å°‘ã—è¿‘ã¥ã„ã¦ãã ã•ã„ã€‚') + ` (${Math.round(dist)}m)`);
        }
      }, err=>{
        alert(t('geo.denied') || 'ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚è¨±å¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
      }, { enableHighAccuracy:true, timeout:8000, maximumAge:60000 });
    }

    /* ===========================
       Render Results (spots + move distinction)
       - fully multilingual using SPOT_I18N
       =========================== */
    function showResults(){
      showScreen('results');
      // travel style text example
      const travelTextMap = {
        relaxed: {'ja':'ã‚†ã£ãŸã‚Šã¨æ¥½ã—ã‚€ã‚³ãƒ¼ã‚¹','en':'Relaxed course','zh':'Relaxed course','ko':'ì—¬ìœ ë¡­ê²Œ ì¦ê¸°ëŠ” ì½”ìŠ¤'},
        active: {'ja':'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«å›ã‚‹ã‚³ãƒ¼ã‚¹','en':'Active course','zh':'Active course','ko':'í™œë™ì ìœ¼ë¡œ ë„ëŠ” ì½”ìŠ¤'},
        cultural: {'ja':'æ–‡åŒ–ãƒ»æ­´å²é‡è¦–ã®ã‚³ãƒ¼ã‚¹','en':'Cultural & history course','zh':'Cultural & history course','ko':'ë¬¸í™”Â·ì—­ì‚¬ ì¤‘ì‹¬ ì½”ìŠ¤'},
        gourmet: {'ja':'ã‚°ãƒ«ãƒ¡ã‚’æ¥½ã—ã‚€ã‚³ãƒ¼ã‚¹','en':'Gourmet-focused course','zh':'Gourmet-focused course','ko':'ë¯¸ì‹ ì¤‘ì‹¬ ì½”ìŠ¤'}
      };
      const travelText = (diagnosisData.travelStyle && travelTextMap[diagnosisData.travelStyle]) ? (travelTextMap[diagnosisData.travelStyle][currentLang] || travelTextMap[diagnosisData.travelStyle]['ja']) : (currentLang==='en'?'Recommended course':'ã‚†ã£ãŸã‚Šã¨æ¥½ã—ã‚€ã‚³ãƒ¼ã‚¹');
      const travelEl = document.getElementById('travel-style-text'); if(travelEl) travelEl.textContent = travelText;

      const spotsList = document.getElementById('spots-list'); spotsList.innerHTML = '';
      DEMO_PLAN.forEach((p, idx)=>{
        const item = document.createElement('div'); item.className = 'timeline-item';
        const dot = document.createElement('div'); dot.className = 'timeline-dot'; item.appendChild(dot);

        const isMove = (p.tags && p.tags.some(tag => ['ç§»å‹•','å¾’æ­©','æ±Ÿãƒé›»','ç§»å‹•','æ­©è¡Œ'].includes(tag))) || /ç§»å‹•|å¾’æ­©|â†’/.test(p.description || '') || /â†’/.test(p.name || '');
        if(isMove){
          const move = document.createElement('div'); move.className = 'move-card';
          const icon = document.createElement('div'); icon.className = 'move-icon'; icon.innerHTML = '<svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7h18M3 12h18M3 17h18"/></svg>';
          const content = document.createElement('div'); content.style.flex = '1';
          const titleRow = document.createElement('div'); titleRow.className = 'flex justify-between items-center';
          const titleLeft = document.createElement('div'); titleLeft.className = 'font-semibold'; titleLeft.textContent = SPOT_I18N[p.id] && SPOT_I18N[p.id].name ? (SPOT_I18N[p.id].name[currentLang] || p.name) : p.name;
          const timeBadge = document.createElement('div'); timeBadge.className = 'time-badge'; timeBadge.textContent = p.startTime || '';
          titleRow.appendChild(titleLeft); titleRow.appendChild(timeBadge);
          const desc = document.createElement('div'); desc.className = 'text-sm text-gray-600 mt-1'; desc.textContent = SPOT_I18N[p.id] && SPOT_I18N[p.id].description ? (SPOT_I18N[p.id].description[currentLang] || p.description) : p.description;
          content.appendChild(titleRow); content.appendChild(desc);
          move.appendChild(icon); move.appendChild(content);
          item.appendChild(move);
        } else {
          const spot = document.createElement('div'); spot.className = 'spot-card';
          const titleRow = document.createElement('div'); titleRow.className = 'flex justify-between items-start';
          const left = document.createElement('div');
          const nameEl = document.createElement('div'); nameEl.className = 'spot-title';
          nameEl.textContent = SPOT_I18N[p.id] && SPOT_I18N[p.id].name ? (SPOT_I18N[p.id].name[currentLang] || p.name) : p.name;
          const descEl = document.createElement('div'); descEl.className = 'spot-desc';
          descEl.textContent = SPOT_I18N[p.id] && SPOT_I18N[p.id].description ? (SPOT_I18N[p.id].description[currentLang] || p.description) : p.description;
          left.appendChild(nameEl); left.appendChild(descEl);
          const timeBadge = document.createElement('div'); timeBadge.className = 'time-badge'; timeBadge.textContent = p.startTime || '';
          titleRow.appendChild(left); titleRow.appendChild(timeBadge);
          spot.appendChild(titleRow);

          // tips (multilingual)
          const tipsArr = SPOT_I18N[p.id] && SPOT_I18N[p.id].tips && SPOT_I18N[p.id].tips[currentLang] ? SPOT_I18N[p.id].tips[currentLang] : p.tips;
          if(tipsArr && tipsArr.length){
            const tipsEl = document.createElement('div'); tipsEl.className = 'spot-tips';
            tipsEl.innerHTML = tipsArr.map(t => `<div>${escapeHtml(t)}</div>`).join('');
            spot.appendChild(tipsEl);
          }

          // check-in controls
          const ckWrap = document.createElement('div'); ckWrap.className = 'mt-2 flex items-center gap-3';
          const checkBtn = document.createElement('button'); checkBtn.className = 'checkin-btn'; checkBtn.textContent = (currentLang==='ja'?'ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³': currentLang==='en'?'Check in': currentLang==='zh'?'ç­¾åˆ°':'ì²´í¬ì¸');
          checkBtn.onclick = ()=>{ tryCheckIn(p); };
          ckWrap.appendChild(checkBtn);

          // checked badge display
          const checkedSpan = document.createElement('div'); checkedSpan.className = 'checked-badge'; checkedSpan.style.display = isChecked(p.id)?'inline-block':'none';
          checkedSpan.textContent = (currentLang==='ja'?'ãƒã‚§ãƒƒã‚¯æ¸ˆ':'Checked');
          ckWrap.appendChild(checkedSpan);

          spot.appendChild(ckWrap);
          item.appendChild(spot);
        }
        spotsList.appendChild(item);
      });

      updateCheckinUI();
      renderCoupons();
    }

    function updateCheckinUI(){
      // update checked badges and checkin rate
      const cs = loadCheckins();
      const spotIds = DEMO_PLAN.filter(p => !(p.tags && p.tags.includes('ç§»å‹•'))).map(p=>p.id);
      const totalSpots = spotIds.length;
      const checkedCount = spotIds.reduce((acc,id)=> acc + (cs[id]?1:0), 0);
      const rate = totalSpots ? Math.round((checkedCount/totalSpots)*100) : 0;
      document.getElementById('checkin-rate').textContent = rate + '%';
      // show/hide checked badges in UI
      document.querySelectorAll('.timeline-item').forEach(item=>{
        const title = item.querySelector('.spot-title');
        if(!title) return;
        const spotName = title.textContent;
        // find id by matching translated name (best-effort)
        const spot = DEMO_PLAN.find(p => {
          const nm = (SPOT_I18N[p.id] && SPOT_I18N[p.id].name && SPOT_I18N[p.id].name[currentLang]) ? SPOT_I18N[p.id].name[currentLang] : p.name;
          return nm === spotName;
        });
        if(!spot) return;
        const badge = item.querySelector('.checked-badge');
        if(badge) badge.style.display = cs[spot.id] ? 'inline-block' : 'none';
      });
      // lottery enable if rate >= LOTTERY_RATE*100
      const lotteryBtn = document.getElementById('lottery-btn');
      if(lotteryBtn) lotteryBtn.disabled = (checkedCount/totalSpots) < LOTTERY_RATE;
    }

    function enterLottery(){
      // demo lottery: random pick if eligible
      const cs = loadCheckins();
      const spotIds = DEMO_PLAN.filter(p => !(p.tags && p.tags.includes('ç§»å‹•'))).map(p=>p.id);
      const totalSpots = spotIds.length;
      const checkedCount = spotIds.reduce((acc,id)=> acc + (cs[id]?1:0), 0);
      if(checkedCount/totalSpots < LOTTERY_RATE){ alert((currentLang==='ja'?'æŠ½é¸ã«å‚åŠ ã™ã‚‹æ¡ä»¶ã‚’æº€ãŸã—ã¦ã„ã¾ã›ã‚“':'Not eligible for lottery yet')); return; }
      // simple "you won" 10% chance
      const won = Math.random() < 0.1;
      if(won) alert((currentLang==='ja'?'ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼æŠ½é¸ã«å½“é¸ã—ã¾ã—ãŸğŸ‰':'Congratulations! You won the lottery!'));
      else alert((currentLang==='ja'?'æ®‹å¿µãªãŒã‚‰ä»Šå›ã¯ãƒã‚ºãƒ¬ã§ã™ã€‚':'Sorry, not a winner this time.'));
    }

    /* ---------- Map ---------- */
    function initMap(){
      if(mapReady) return;
      const mapDiv = document.getElementById('map'); if(!mapDiv) return;
      mapInstance = L.map('map', { zoomControl:true }).setView([35.32,139.48],13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(mapInstance);
      const latlngs = [];
      DEMO_PLAN.forEach(p=>{ if(p.lat && p.lng){ L.marker([p.lat,p.lng]).addTo(mapInstance).bindPopup(`<strong>${escapeHtml((SPOT_I18N[p.id] && SPOT_I18N[p.id].name && SPOT_I18N[p.id].name[currentLang])?SPOT_I18N[p.id].name[currentLang]:p.name)}</strong><br>${escapeHtml(p.description)}`); latlngs.push([p.lat,p.lng]); } });
      if(latlngs.length) mapInstance.fitBounds(latlngs,{ padding:[40,40] });
      mapReady = true;
    }

    /* ---------- Coupons rendering ---------- */
    function renderCoupons(){
      const list = document.getElementById('coupon-list'); if(!list) return;
      list.innerHTML = '';
      DEMO_COUPONS.forEach(c=>{
        const title = c.title[currentLang] || c.title['ja'];
        const desc = c.description[currentLang] || c.description['ja'];
        const item = document.createElement('div'); item.className = 'bg-white rounded-2xl p-4 flex items-start gap-3 glass';
        item.innerHTML = `<div class="flex-1"><div class="font-semibold text-gray-800">${escapeHtml(title)}</div><div class="text-xs text-gray-500 mt-1">${escapeHtml(desc)}</div><div class="text-xs text-gray-400 mt-2">æœ‰åŠ¹æœŸé™: ${escapeHtml(c.validUntil)}</div></div><div class="flex flex-col gap-2"><button class="w-24 h-10 rounded-xl bg-[color:var(--sea-mid)] text-white" onclick="viewCoupon('${c.id}')">è©³ç´°</button>${c.used?'<div class="text-xs text-gray-400">ä½¿ç”¨æ¸ˆã¿</div>':''}</div>`;
        list.appendChild(item);
      });
    }

    function viewCoupon(id){
      const c = DEMO_COUPONS.find(x=>x.id===id); if(!c) return;
      document.getElementById('cd-title').textContent = c.title[currentLang] || c.title['ja'];
      document.getElementById('cd-spot').textContent = c.spotName || '';
      document.getElementById('cd-desc').textContent = c.description[currentLang] || c.description['ja'];
      document.getElementById('cd-discount').textContent = c.discount;
      document.getElementById('cd-valid').textContent = (currentLang==='ja'?'æœ‰åŠ¹æœŸé™: ':'Valid until: ') + c.validUntil;
      document.getElementById('cd-status').textContent = c.used ? (currentLang==='ja'?'ä½¿ç”¨æ¸ˆã¿':'Used') : '';
      const useBtn = document.getElementById('cd-use');
      useBtn.onclick = ()=>{ if(c.used){ alert(currentLang==='ja'?'æ—¢ã«ä½¿ç”¨æ¸ˆã¿ã§ã™':'Already used'); return; } if(confirm(currentLang==='ja'?t('coupon.confirm'):t('coupon.confirm'))){ c.used=true; document.getElementById('cd-status').textContent = currentLang==='ja'?'ä½¿ç”¨æ¸ˆã¿':'Used'; renderCoupons(); showScreen('coupons'); } };
      showScreen('coupon-detail');
    }

    /* ---------- Geo message keys for i18n (fallbacks) ---------- */
    TEXTS.ja['geo.unavailable'] = 'ä½ç½®æƒ…å ±ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“';
    TEXTS.en['geo.unavailable'] = 'Geolocation is not available';
    TEXTS.ja['geo.denied'] = 'ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚è¨±å¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
    TEXTS.en['geo.denied'] = 'Failed to get location. Check permissions.';
    TEXTS.ja['checkin.success'] = 'ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³æˆåŠŸï¼ğŸ‰';
    TEXTS.en['checkin.success'] = 'Check-in successful!';
    TEXTS.ja['checkin.too_far'] = 'ã‚‚ã†å°‘ã—è¿‘ã¥ã„ã¦ãã ã•ã„ã€‚';
    TEXTS.en['checkin.too_far'] = 'Please get closer to the spot.';

    /* ---------- Language change handler ---------- */
    document.getElementById('lang-select').addEventListener('change', (e)=>{
      currentLang = e.target.value;
      applyI18n();
      renderQuestion(); // update question text
      // If results visible, re-render to update SPOT translations and labels
      if(!document.getElementById('results-screen').classList.contains('hidden')) showResults();
      if(mapReady) { /* reposition popups to localized names if necessary */ }
    });

    /* ---------- Initial rendering and helpers ---------- */
    applyI18n();
    showScreen('intro');

    // Expose some functions in console for testing
    window.showResults = showResults;
    window.resetCheckins = resetCheckins;
  </script>
</body>
</html>
